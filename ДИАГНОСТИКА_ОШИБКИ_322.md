# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ 322 "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å"

**–î–∞—Ç–∞:** 20 –Ω–æ—è–±—Ä—è 2025  
**–û—à–∏–±–∫–∞:** `322 - –ü–µ—Ä–µ–¥–∞–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å Init; Payment`

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏

–°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ A2C_V2 (—Å—Ç—Ä. 4469):

```
322 - –ü–µ—Ä–µ–¥–∞–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å Init; Payment
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä `Token` (–ø–æ–¥–ø–∏—Å—å SHA-256) —Ä–∞—Å—Å—á–∏—Ç–∞–Ω **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**.

---

## üîê –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏

–°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¢-–ë–∞–Ω–∫:

1. –í–∑—è—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
2. –î–æ–±–∞–≤–∏—Ç—å `Password` —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
3. **–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å** –∫–ª—é—á–∏ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
4. **–ö–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞—Ç—å** –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ –∫–ª—é—á–∏!)
5. –í—ã—á–∏—Å–ª–∏—Ç—å **SHA-256** —Ö–µ—à

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**

- –î–ª—è **E2C —Ç–µ—Ä–º–∏–Ω–∞–ª–∞** (`1763372956356E2C`) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **`TBANK_E2C_PASSWORD`**
- –î–ª—è **EACQ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞** (`1763372956356`) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **`TBANK_PASSWORD`**
- –ü–∞—Ä–æ–ª–∏ **–†–ê–ó–ù–´–ï**!

---

## üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–∏

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ E2C –ø–∞—Ä–æ–ª—è

```bash
cd ~/nesi-app
grep TBANK_E2C_PASSWORD .env
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```
TBANK_E2C_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å_–æ—Ç_E2C_—Ç–µ—Ä–º–∏–Ω–∞–ª–∞
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `test-signature.js` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏.

**–ù–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:**

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `test-signature.js` –Ω–∞ —Å–≤–æ–π –ü–ö
2. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
3. **–ó–∞–º–µ–Ω–∏—Ç–µ** `–í–ê–®_–ü–ê–†–û–õ–¨_E2C` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–∑ `.env`
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
node test-signature.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:
{
  "TerminalKey": "1763372956356E2C",
  "Amount": 10000,
  "OrderId": "withdraw_...",
  "DealId": "56868517",
  "PaymentRecipientId": "79662765973",
  "Phone": "79662765973",
  "SbpMemberId": "100000000004",
  "FinalPayout": true,
  "NotificationURL": "https://nesi.su/api/wallet/tbank/webhook"
}

üîë –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏:
[
  'Amount',
  'DealId',
  'FinalPayout',
  'NotificationURL',
  'OrderId',
  'Password',
  'PaymentRecipientId',
  'Phone',
  'SbpMemberId',
  'TerminalKey'
]

üîó –ö–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:
10000568685171763372956356E2Ctruehttps://nesi.su/api/wallet/tbank/webhookwithdraw_...–í–ê–®_–ü–ê–†–û–õ–¨79662765973796627659731000000000041763372956356E2C

üîê –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Token:
6c84a0fd02acf2aa97135c8611543aa189c586baabf34bd8397ce9bc7397d362

‚úÖ –ü–æ–¥–ø–∏—Å–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç! –ü–∞—Ä–æ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.
```

–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∏ **–ù–ï —Å–æ–≤–ø–∞–¥–∞—é—Ç** ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å E2C!

---

## üéØ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ 322

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å E2C —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
grep TBANK_E2C_PASSWORD .env
```

**–†–µ—à–µ–Ω–∏–µ:**

1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¢-–ë–∞–Ω–∫
2. –ù–∞–π–¥–∏—Ç–µ E2C —Ç–µ—Ä–º–∏–Ω–∞–ª (`1763372956356E2C`)
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–ø–∞—Ä–æ–ª—å –¥–ª—è E2C**
4. –û–±–Ω–æ–≤–∏—Ç–µ `.env`:

```bash
nano .env
# –î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ:
TBANK_E2C_PASSWORD=–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_–ø–∞—Ä–æ–ª—å_E2C
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –æ—Ç EACQ –≤–º–µ—Å—Ç–æ E2C

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–¥–µ:**

```typescript
// src/lib/tbank.ts, —Å—Ç—Ä–æ–∫–∞ 356
const e2cPassword = process.env.TBANK_E2C_PASSWORD // ‚Üê –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–º–µ–Ω–Ω–æ E2C!
```

**–†–µ—à–µ–Ω–∏–µ:**  
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `TBANK_E2C_PASSWORD`, –∞ –Ω–µ `TBANK_PASSWORD`.

### 3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**  
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è **–ø–æ –∫–ª—é—á–∞–º**:

```
Amount ‚Üí DealId ‚Üí FinalPayout ‚Üí ... ‚Üí TerminalKey
```

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –¥–ª—è FinalPayout

**–í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (—Å—Ç—Ä. 903):**

```json
"FinalPayout": "true"  ‚Üê –°—Ç—Ä–æ–∫–∞
```

**–í –∫–æ–¥–µ:**

```typescript
requestBody.FinalPayout = true // ‚Üê boolean
```

**–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ —Å—Ç—Ä–æ–∫—É:**

```typescript
if (params.finalPayout) {
	requestBody.FinalPayout = 'true' // ‚Üê –°—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ boolean
}
```

### 5. –ü–∞—Ä–æ–ª—å —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏–ª–∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```bash
# –î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è
grep TBANK_E2C_PASSWORD .env | wc -c
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:

- –ù–µ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ
- –ù–µ—Ç –∫–∞–≤—ã—á–µ–∫ –≤–æ–∫—Ä—É–≥ –ø–∞—Ä–æ–ª—è
- –§–æ—Ä–º–∞—Ç: `TBANK_E2C_PASSWORD=password` (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫)

---

## üõ†Ô∏è –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å E2C:**
   ```bash
   grep TBANK_E2C_PASSWORD .env
   ```
2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ `test-signature.js`** —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º

3. **–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∏ –ù–ï —Å–æ–≤–ø–∞–¥–∞—é—Ç:**

   - –ü–æ–ª—É—á–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –¢-–ë–∞–Ω–∫
   - –û–±–Ω–æ–≤–∏—Ç–µ `.env`
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

4. **–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –Ω–æ –æ—à–∏–±–∫–∞ 322 –æ—Å—Ç–∞–µ—Ç—Å—è:**
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å `FinalPayout` –Ω–∞ —Å—Ç—Ä–æ–∫—É `"true"`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π –ø–æ–¥–ø–∏—Å–∏

---

## üìä –õ–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤ –∫–æ–¥–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:

```
üîê [TBANK] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏: {
  hasE2cPassword: true,
  e2cPasswordLength: XX,
  parametersForSignature: [
    'Amount',
    'DealId',
    'FinalPayout',
    'NotificationURL',
    'OrderId',
    'PaymentRecipientId',
    'Phone',
    'SbpMemberId',
    'TerminalKey'
  ]
}

üîê [GENERATE-TOKEN] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ E2C: {
  sortedKeys: [...],
  concatenatedLength: XXX,
  concatenatedPreview: '...'
}
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:

- `hasE2cPassword: true` ‚Üê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
- `e2cPasswordLength` ‚Üê —Ä–∞–∑—É–º–Ω–∞—è –¥–ª–∏–Ω–∞ (20-50 —Å–∏–º–≤–æ–ª–æ–≤)
- `sortedKeys` ‚Üê –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫

---

## ‚úÖ –ò—Ç–æ–≥–æ

–û—à–∏–±–∫–∞ 322 = **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å**.

**–°–∞–º–∞—è –≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è E2C —Ç–µ—Ä–º–∏–Ω–∞–ª–∞.

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü–æ–ª—É—á–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å E2C –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –¢-–ë–∞–Ω–∫
2. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`: `TBANK_E2C_PASSWORD=–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_–ø–∞—Ä–æ–ª—å`
3. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ `test-signature.js` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏!** üîê
