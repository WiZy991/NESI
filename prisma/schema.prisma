generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
model User {
  id          String               @id @default(cuid())
  email       String               @unique
  password    String
  resetTokens PasswordResetToken[]
  role        Role                 @default(user)
  verified    Boolean              @default(false)
  blocked     Boolean              @default(false)
  blockedUntil DateTime?
  blockedReason String?
  fullName    String?
  createdAt   DateTime             @default(now())
  description  String?
  avatarUrl    String?
  avatarFileId String? @unique
  avatarFile   File?   @relation("UserAvatar", fields: [avatarFileId], references: [id])
  lastPrivateMessageReadAt DateTime?          @map("lastPrivateMessageReadAt")
  location String?
  skills   String[]
  tasks           Task[]         @relation("Customer")
  executedTasks   Task[]         @relation("Executor")
  responses       TaskResponse[]
  reviewsAuthored Review[]       @relation("FromUser")
  reviewsReceived Review[]       @relation("ToUser")
  messages        Message[]      @relation("MessageSender")
  notifications   Notification[]
  certificationAttempts CertificationAttempt[]
  certifications        UserCertification[]
  levelId             String?    @map("level_id")
  level               UserLevel? @relation(fields: [levelId], references: [id])
  xp                  Int        @default(0)
  completedTasksCount Int        @default(0)
  avgRating           Float      @default(0)
  badges               UserBadge[]
  hireRequestsSent     HireRequest[] @relation("HireCustomer")
  hireRequestsReceived HireRequest[] @relation("HireExecutor")
  privateMessagesSent     PrivateMessage[] @relation("PrivateMessageSender")
  privateMessagesReceived PrivateMessage[] @relation("PrivateMessageRecipient")

  balance       Decimal       @default(0.00) @db.Decimal(15, 2)
  transactions  Transaction[]
  frozenBalance Decimal       @default(0.00) @db.Decimal(15, 2)
  communityPosts          CommunityPost[]
  communityComments       CommunityComment[]
  communityLikes          CommunityLike[]
  emailVerificationTokens EmailVerificationToken[]
  adminLogs               AdminActionLog[]
  disputes                Dispute[]
  settings UserSettings?
  reports   CommunityReport[]  @relation("UserReports")
  activityLogs ActivityLog[]
  
  // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
  referralCode String? @unique
  referredById String?
  referredBy   User?   @relation("Referrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals    User[]  @relation("Referrals")
  referralBonusesEarned ReferralBonus[] @relation("ReferrerBonuses")
  referralBonusesGiven  ReferralBonus[] @relation("ReferralBonuses")
  
  // –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ
  portfolioItems Portfolio[]
  
  // –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  messageReactions MessageReaction[]
  
  // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
  dailyQuestProgress DailyQuestProgress[]
  lastQuestResetDate DateTime?
}
model UserSettings {
  userId             String  @id
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(false)
  showOnlineStatus   Boolean @default(true)
  hideEmail          Boolean @default(false)
  user User @relation(fields: [userId], references: [id])
}
model Task {
  id                 String         @id @default(uuid())
  title              String
  description        String
  price              Decimal?       @db.Decimal(15, 2)
  deadline           DateTime?
  status             String         @default("open")
  customerId         String
  executorId         String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  completedAt        DateTime?
  subcategoryId      String?
  escrowAmount       Decimal       @default(0.00) @db.Decimal(15, 2)
  customerLastReadAt DateTime?
  executorLastReadAt DateTime?
  Dispute            Dispute[]
  files              File[]         @relation("TaskFiles")
  messages           Message[]
  review             Review[]
  customer           User           @relation("Customer", fields: [customerId], references: [id])
  executor           User?          @relation("Executor", fields: [executorId], references: [id])
  subcategory        Subcategory?   @relation(fields: [subcategoryId], references: [id])
  responses          TaskResponse[]
  Transaction        Transaction[]
  reports            CommunityReport[]  // –ñ–∞–ª–æ–±—ã –Ω–∞ –∑–∞–¥–∞—á—É
  portfolioItems     Portfolio[]
  referralBonuses    ReferralBonus[]

  @@index([status])
  @@index([customerId])
  @@index([executorId])
  @@index([subcategoryId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([customerId, status])
  @@index([executorId, status])
}
model TaskResponse {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  message   String?
  createdAt DateTime @default(now())
  price     Decimal? @db.Decimal(15, 2)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  @@unique([taskId, userId], name: "taskId_userId")
  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
}
model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String
  createdAt  DateTime @default(now())
  taskId     String
  fromUserId String?
  toUserId   String?
  fromUser   User?    @relation("FromUser", fields: [fromUserId], references: [id])
  toUser     User?    @relation("ToUser", fields: [toUserId], references: [id])
  task       Task     @relation(fields: [taskId], references: [id])
  @@unique([taskId, fromUserId], name: "task_from_reviewer")
}
model Message {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  editedAt  DateTime?
  deletedAt DateTime?
  taskId    String
  senderId  String
  content   String
  fileUrl   String?
  fileId    String?
  file      File?     @relation("MessageFile", fields: [fileId], references: [id])
  sender    User      @relation("MessageSender", fields: [senderId], references: [id])
  task      Task      @relation(fields: [taskId], references: [id])
  
  reactions MessageReaction[]

  @@index([taskId])
  @@index([senderId])
  @@index([createdAt])
  @@index([taskId, createdAt])
}
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([userId, createdAt])
}
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  User      User     @relation(fields: [userId], references: [id])
}
model Category {
  id            String        @id @default(uuid())
  name          String        @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  subcategories Subcategory[]
}
model Subcategory {
  id                 String              @id @default(uuid())
  name               String              @unique
  categoryId         String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  minPrice           Decimal             @default(500.00) @db.Decimal(15, 2)
  certificationTest  CertificationTest?
  category           Category            @relation(fields: [categoryId], references: [id])
  tasks              Task[]
  userCertifications UserCertification[]
}
model CertificationTest {
  id            String                  @id @default(uuid())
  subcategoryId String                  @unique
  title         String
  timeLimitSec  Int
  passScore     Int
  questionCount Int
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  attempts      CertificationAttempt[]
  questions     CertificationQuestion[]
  subcategory   Subcategory             @relation(fields: [subcategoryId], references: [id])
}
model CertificationQuestion {
  id        String                @id @default(uuid())
  testId    String
  text      String
  createdAt DateTime              @default(now())
  options   CertificationOption[]
  test      CertificationTest     @relation(fields: [testId], references: [id])
  @@index([testId])
}
model CertificationOption {
  id         String                @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean               @default(false)
  question   CertificationQuestion @relation(fields: [questionId], references: [id])
  @@index([questionId])
}
model CertificationAttempt {
  id         String            @id @default(uuid())
  userId     String
  testId     String
  startedAt  DateTime          @default(now())
  finishedAt DateTime?
  score      Int?
  passed     Boolean?
  test       CertificationTest @relation(fields: [testId], references: [id])
  user       User              @relation(fields: [userId], references: [id])
  @@index([userId])
  @@index([testId])
  @@index([userId, testId, startedAt])
}
model UserCertification {
  id            String      @id @default(uuid())
  userId        String
  subcategoryId String
  level         String      @default("CERTIFIED")
  grantedAt     DateTime    @default(now())
  subcategory   Subcategory @relation(fields: [subcategoryId], references: [id])
  user          User        @relation(fields: [userId], references: [id])
  @@unique([userId, subcategoryId], name: "userId_subcategoryId")
  @@index([subcategoryId])
}
model UserLevel {
  id          String @id @default(uuid())
  slug        String @unique
  name        String
  description String
  minScore    Int
  users       User[]
}
model Badge {
  id          String      @id @default(cuid())
  name        String
  description String
  icon        String
  condition   String
  users       UserBadge[]
}
model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  badge    Badge    @relation(fields: [badgeId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
}
model HireRequest {
  id         String   @id @default(uuid())
  customerId String
  executorId String
  message    String?  @db.Text
  amount     Decimal  @default(1990.00) @db.Decimal(15, 2)
  createdAt  DateTime @default(now())
  paid       Boolean  @default(false)
  status     String   @default("pending")
  customer   User     @relation("HireCustomer", fields: [customerId], references: [id])
  executor   User     @relation("HireExecutor", fields: [executorId], references: [id])
}
model PrivateMessage {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String
  content     String?
  fileUrl     String?
  mimeType    String?
  fileName    String?
  size        Int?
  createdAt   DateTime  @default(now())
  editedAt    DateTime?
  deletedAt   DateTime?
  fileId      String?
  file        File?     @relation("PrivateMessageFile", fields: [fileId], references: [id])
  recipient   User      @relation("PrivateMessageRecipient", fields: [recipientId], references: [id])
  sender      User      @relation("PrivateMessageSender", fields: [senderId], references: [id])
  
  reactions PrivateMessageReaction[]
}
model AdminInvite {
  id        String   @id @default(cuid())
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  usedBy    String?  @db.Uuid
}
model Transaction {
  id         String   @id @default(cuid())
  userId     String
  amount     Decimal  @db.Decimal(15, 2)
  type       String
  reason     String
  createdAt  DateTime @default(now())
  reviewedBy String?
  status     String   @default("pending")
  taskId     String?
  Task       Task?    @relation(fields: [taskId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
}
model File {
  id          String           @id @default(cuid())
  filename    String
  mimetype    String
  size        Int
  data        Bytes?
  url         String?
  createdAt   DateTime         @default(now())
  taskId      String?
  task        Task?            @relation("TaskFiles", fields: [taskId], references: [id])
  messages    Message[]        @relation("MessageFile")
  privateMsgs PrivateMessage[] @relation("PrivateMessageFile")
  userAvatar  User?            @relation("UserAvatar")
}
model CommunityPost {
  id        String             @id @default(cuid())
  authorId  String
  title     String
  content   String
  imageUrl  String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  likes     CommunityLike[]
  views     CommunityView[]
  isDeleted       Boolean  @default(false)
  deletedReason   String?  // "–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª", "–°–ø–∞–º" –∏ —Ç.–¥.
  author       User?       @relation(fields: [authorId], references: [id])
  comments     CommunityComment[]
  reports      CommunityReport[]
  @@index([authorId])
  @@index([createdAt])
  @@index([authorId, createdAt])
}
model CommunityComment {
  id        String        @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime      @default(now())
  parentId  String?
  imageUrl  String?
  author    User          @relation(fields: [authorId], references: [id])
  post      CommunityPost @relation(fields: [postId], references: [id])
  reports     CommunityReport[]
  @@index([postId])
  @@index([authorId])
  @@index([createdAt])
  @@index([postId, createdAt])
}
model CommunityLike {
  id     String        @id @default(cuid())
  postId String
  userId String
  post   CommunityPost @relation(fields: [postId], references: [id])
  user   User          @relation(fields: [userId], references: [id])
  @@unique([postId, userId], name: "postId_userId")
}
model CommunityView {
  id        String        @id @default(cuid())
  postId    String
  userId    String?
  createdAt DateTime      @default(now())
  post      CommunityPost @relation(fields: [postId], references: [id])
}
model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
model AdminActionLog {
  id         String   @id @default(uuid())
  adminId    String
  action     String
  entityType String
  entityId   String?
  details    String?
  createdAt  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id])
}
model SystemMetric {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Float?
  stringVal String?
  createdAt DateTime @default(now())
}
model Dispute {
  id            String    @id
  taskId        String
  userId        String
  reason        String
  details       String?
  status        String    @default("open")
  resolution    String?
  createdAt     DateTime  @default(now())
  resolvedAt    DateTime?
  adminDecision String?
  Task          Task      @relation(fields: [taskId], references: [id])
  User          User      @relation(fields: [userId], references: [id])
  @@index([status])
  @@index([taskId])
  @@index([userId])
}
model CommunityReport {
  id          String   @id @default(cuid())
  type        String   // "post", "comment", "task"
  postId      String?
  commentId   String?
  taskId      String?  // –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –∂–∞–ª–æ–± –Ω–∞ –∑–∞–¥–∞—á–∏
  reason      String
  description String?
  reporterId  String?
  createdAt   DateTime @default(now())
  reporter    User?    @relation("UserReports", fields: [reporterId], references: [id])
  post        CommunityPost?     @relation(fields: [postId], references: [id])
  comment     CommunityComment? @relation(fields: [commentId], references: [id])
  task        Task?              @relation(fields: [taskId], references: [id])
 
  @@index([taskId])
  @@index([reporterId])
  @@index([type])
}
model Feedback {
  id        String   @id @default(cuid())
  name      String
  email     String?
  message   String   @db.Text
  type      String   @default("general")
  status    String   @default("new")
  createdAt DateTime @default(now())
  reviewedAt DateTime?
  reviewedBy String?
  notes     String?  @db.Text
}
model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime @default(now())
 
  user User @relation(fields: [userId], references: [id])
 
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ========================================
// –ù–û–í–´–ï –ú–û–î–ï–õ–ò –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–ô 2025
// ========================================

// –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
model Portfolio {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String   @db.Text
  imageUrl    String?
  externalUrl String?
  taskId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([createdAt])
}

// –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
model ReferralBonus {
  id         String   @id @default(cuid())
  referrerId String   // –ö—Ç–æ –ø—Ä–∏–≤–µ–ª
  referralId String   // –ö–æ–≥–æ –ø—Ä–∏–≤–µ–ª–∏
  taskId     String
  amount     Decimal  @db.Decimal(15, 2)
  createdAt  DateTime @default(now())
  
  referrer User @relation("ReferrerBonuses", fields: [referrerId], references: [id], onDelete: Cascade)
  referral User @relation("ReferralBonuses", fields: [referralId], references: [id], onDelete: Cascade)
  task     Task @relation(fields: [taskId], references: [id])
  
  @@index([referrerId])
  @@index([referralId])
  @@index([taskId])
}

// –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö –∑–∞–¥–∞—á
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String   // "üëç", "‚ù§Ô∏è", "üòÇ", "üòÆ", "üò¢", "üî•"
  createdAt DateTime @default(now())
  
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

// –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
model PrivateMessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  
  message PrivateMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

// –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏
model DailyQuest {
  id          String   @id @default(cuid())
  code        String   @unique  // "respond_3_tasks", "complete_task_on_time"
  title       String
  description String
  xpReward    Int      @default(10)
  targetCount Int      @default(1)  // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  progress DailyQuestProgress[]
}

// –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º –∑–∞–¥–∞–Ω–∏—è–º
model DailyQuestProgress {
  id          String   @id @default(cuid())
  userId      String
  questId     String
  currentCount Int     @default(0)
  completed   Boolean  @default(false)
  completedAt DateTime?
  date        DateTime @default(now())  // –î–∞—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–Ω–µ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest DailyQuest @relation(fields: [questId], references: [id], onDelete: Cascade)
  
  @@unique([userId, questId, date])
  @@index([userId])
  @@index([questId])
  @@index([date])
}

enum Role {
  user
  executor
  admin
  customer
}