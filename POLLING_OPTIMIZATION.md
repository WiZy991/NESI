# Оптимизация Polling для предотвращения блокировок Beget

## Проблема

Beget блокировал порты на исходящие запросы, утверждая, что с IP-адреса сервера идут DDoS-атаки на немецкие и испанские сайты. Проблема появилась после добавления polling для отслеживания уведомлений.

## Выявленные проблемы

### 1. Слишком частые запросы

- **Было**: Polling уведомлений каждые 5 секунд
- **Проблема**: При 100 пользователях онлайн = 20 запросов в секунду только на polling
- **Решение**: Увеличено до 30 секунд (снижение нагрузки в 6 раз)

### 2. Отсутствие защиты от множественных запросов

- **Проблема**: Если пользователь открывал несколько вкладок, каждая делала polling
- **Решение**: Добавлена защита от множественных одновременных запросов

### 3. Отсутствие rate limiting на сервере

- **Проблема**: Нет ограничений на количество запросов от одного пользователя
- **Решение**: Добавлен rate limiting - максимум 3 запроса в минуту на пользователя

### 4. Отсутствие обработки ошибок

- **Проблема**: При ошибках запросы повторялись без задержки
- **Решение**: Добавлена экспоненциальная задержка при ошибках (максимум 5 минут)

### 5. Polling неактивных вкладок

- **Проблема**: Polling продолжался даже когда вкладка была неактивна
- **Решение**: Добавлена проверка активности вкладки через Page Visibility API

## Внесенные изменения

### 1. `src/components/NotificationPolling.tsx`

- ✅ Увеличен интервал с 5 до 30 секунд
- ✅ Добавлена защита от множественных одновременных запросов
- ✅ Добавлена экспоненциальная задержка при ошибках
- ✅ Добавлена проверка активности вкладки
- ✅ Добавлен таймаут для запросов (10 секунд)
- ✅ Улучшена обработка ошибок

### 2. `src/components/Header.tsx`

- ✅ Изменен интервал polling с 5000 на 30000 мс

### 3. `src/app/api/notifications/poll/route.ts`

- ✅ Добавлен rate limiting: максимум 3 запроса в минуту на пользователя
- ✅ Добавлены заголовки Retry-After для клиента

## Рекомендации

### Немедленные действия

1. ✅ **Выполнено**: Увеличить интервал polling до 30 секунд
2. ✅ **Выполнено**: Добавить rate limiting на сервере
3. ✅ **Выполнено**: Добавить защиту от множественных запросов
4. ✅ **Выполнено**: Добавить проверку активности вкладки

### Дополнительные рекомендации

#### 1. Мониторинг запросов

```bash
# Проверить количество запросов к polling API
grep "Polling запрос" /var/log/nginx/access.log | wc -l

# Проверить количество 429 ошибок (rate limit)
grep "429" /var/log/nginx/access.log | wc -l
```

#### 2. Настройка Nginx

Добавьте в конфигурацию Nginx ограничения:

```nginx
# Ограничение на количество запросов с одного IP
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req zone=api_limit burst=20 nodelay;

# Применить к polling endpoint
location /api/notifications/poll {
    limit_req zone=api_limit burst=5 nodelay;
}
```

#### 3. Использование Redis для rate limiting

Текущая реализация использует in-memory хранилище, что не работает в кластере. Для продакшена рекомендуется Redis:

```typescript
// В src/lib/rateLimit.ts заменить Map на Redis
import Redis from 'ioredis'
const redis = new Redis(process.env.REDIS_URL)
```

#### 4. Альтернатива: WebSocket вместо polling

Для долгосрочного решения рассмотрите использование WebSocket вместо polling:

- Меньше запросов
- Реальное время
- Меньше нагрузка на сервер

#### 5. Проверка внешних запросов

Если Beget продолжает жаловаться на запросы к внешним сайтам:

1. Проверьте логи сервера на наличие внешних запросов:
   ```bash
   netstat -an | grep ESTABLISHED | grep -v 127.0.0.1
   ```
2. Проверьте, нет ли скриптов, делающих внешние запросы
3. Проверьте, не используется ли прокси/CDN, который может делать запросы

## Ожидаемые результаты

После внесенных изменений:

- **Снижение нагрузки**: В 6 раз меньше запросов (с 5 до 30 секунд)
- **Защита от злоупотреблений**: Rate limiting предотвращает слишком частые запросы
- **Экономия ресурсов**: Polling неактивных вкладок отключен
- **Устойчивость к ошибкам**: Экспоненциальная задержка при проблемах

## Мониторинг

После деплоя проверьте:

1. Количество запросов к `/api/notifications/poll` в логах
2. Количество 429 ошибок (должно быть минимальным)
3. Использование CPU и памяти сервера
4. Отсутствие блокировок от Beget

## Контакты Beget

Если проблема повторится, свяжитесь с поддержкой Beget и предоставьте:

- Логи сервера, показывающие только внутренние запросы
- Информацию о rate limiting
- Подтверждение, что внешние запросы не делаются



