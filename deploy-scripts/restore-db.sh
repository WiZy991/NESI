#!/bin/bash

# ============================================
# –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞
# ============================================

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
DB_USER="nesi_user"
DB_NAME="nesi_db"
BACKUP_DIR="/home/nesi/backups"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}============================================${NC}"
echo -e "${BLUE}üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö${NC}"
echo -e "${BLUE}============================================${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –±—ç–∫–∞–ø–∞–º–∏
if [ ! -d "$BACKUP_DIR" ]; then
    echo -e "${RED}‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –±—ç–∫–∞–ø–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $BACKUP_DIR${NC}"
    exit 1
fi

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤
echo -e "\n${YELLOW}üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã:${NC}"
BACKUPS=($(ls -t $BACKUP_DIR/nesi_db_*.sql.gz 2>/dev/null))

if [ ${#BACKUPS[@]} -eq 0 ]; then
    echo -e "${RED}‚ùå –ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ $BACKUP_DIR${NC}"
    exit 1
fi

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å –Ω–æ–º–µ—Ä–∞–º–∏
for i in "${!BACKUPS[@]}"; do
    SIZE=$(du -h "${BACKUPS[$i]}" | cut -f1)
    DATE=$(basename "${BACKUPS[$i]}" | sed 's/nesi_db_\(.*\)\.sql\.gz/\1/')
    echo -e "  ${BLUE}[$((i+1))]${NC} $DATE (—Ä–∞–∑–º–µ—Ä: $SIZE)"
done

# –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo -e "\n${YELLOW}–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –±—ç–∫–∞–ø–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞):${NC}"
read -p "–ù–æ–º–µ—Ä: " CHOICE

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞
if [ "$CHOICE" = "q" ] || [ "$CHOICE" = "Q" ]; then
    echo -e "${YELLOW}–û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
    exit 0
fi

# –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞
if ! [[ "$CHOICE" =~ ^[0-9]+$ ]] || [ "$CHOICE" -lt 1 ] || [ "$CHOICE" -gt ${#BACKUPS[@]} ]; then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä${NC}"
    exit 1
fi

# –ü–æ–ª—É—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
SELECTED_BACKUP="${BACKUPS[$((CHOICE-1))]}"
echo -e "\n${BLUE}–í—ã–±—Ä–∞–Ω –±—ç–∫–∞–ø:${NC} $(basename $SELECTED_BACKUP)"

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
echo -e "\n${RED}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ $DB_NAME –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!${NC}"
read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo -e "${YELLOW}–û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
    exit 0
fi

# –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –ë–î –ø–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
echo -e "\n${YELLOW}üì¶ –°–æ–∑–¥–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
CURRENT_BACKUP="$BACKUP_DIR/pre_restore_$(date +%Y%m%d_%H%M%S).sql"
pg_dump -U $DB_USER $DB_NAME > $CURRENT_BACKUP
gzip $CURRENT_BACKUP
echo -e "${GREEN}‚úÖ –¢–µ–∫—É—â–∞—è –±–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: ${CURRENT_BACKUP}.gz${NC}"

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
echo -e "\n${YELLOW}üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞...${NC}"

# –†–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
if zcat $SELECTED_BACKUP | psql -U $DB_USER $DB_NAME > /dev/null 2>&1; then
    echo -e "${GREEN}============================================${NC}"
    echo -e "${GREEN}‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!${NC}"
    echo -e "${GREEN}============================================${NC}"
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ë–î
    echo -e "\n${BLUE}üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:${NC}"
    psql -U $DB_USER -d $DB_NAME -c "\dt" 2>/dev/null | head -20
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
    echo -e "\n${YELLOW}üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:${NC}"
    echo -e "   ${BLUE}pm2 restart nesi-app${NC}"
    
else
    echo -e "${RED}============================================${NC}"
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!${NC}"
    echo -e "${RED}============================================${NC}"
    
    echo -e "\n${YELLOW}üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏:${NC}"
    echo -e "   ${BLUE}zcat ${CURRENT_BACKUP}.gz | psql -U $DB_USER $DB_NAME${NC}"
    
    exit 1
fi

