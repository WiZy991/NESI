#!/bin/bash
# ==================================================
# –°–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—à–∏–±–∫–∏ 502 Bad Gateway
# ==================================================

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ 502 Bad Gateway..."
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 3000
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 3000..."
if lsof -i :3000 > /dev/null 2>&1; then
    echo "‚úÖ –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç"
    lsof -i :3000
else
    echo "‚ùå –ü–æ—Ä—Ç 3000 –ù–ï –ó–ê–ù–Ø–¢!"
    echo "   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 3000"
fi
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2 —Å—Ç–∞—Ç—É—Å
echo "2Ô∏è‚É£ –°—Ç–∞—Ç—É—Å PM2..."
pm2 list
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "3Ô∏è‚É£ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 logs nesi-app --lines 50 --nostream
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL..."
if command -v psql &> /dev/null; then
    if PGPASSWORD="$DATABASE_PASSWORD" psql -h localhost -U nesi -d nesi_db -c "SELECT 1;" > /dev/null 2>&1; then
        echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        echo "‚ùå –ù–ï –ú–û–ñ–ï–¢ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ö –ë–î!"
        echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: DATABASE_URL"
    fi
else
    echo "‚ö†Ô∏è psql –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ë–î"
fi
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞..."
if [ -f "/home/nesi/nesi-app/.env" ]; then
    echo "‚úÖ –§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ JWT_SECRET –∏ DATABASE_URL"
    grep -E "JWT_SECRET|DATABASE_URL|NODE_ENV" /home/nesi/nesi-app/.env | sed 's/=.*/=***/'
else
    echo "‚ùå –§–∞–π–ª .env –ù–ï –ù–ê–ô–î–ï–ù!"
    echo "   –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏"
fi
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx
echo "6Ô∏è‚É£ –°—Ç–∞—Ç—É—Å Nginx..."
if systemctl is-active --quiet nginx; then
    echo "‚úÖ Nginx –∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ùå Nginx –ù–ï –ó–ê–ü–£–©–ï–ù!"
fi
echo ""

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—à–∏–±–æ–∫ nginx
echo "7Ô∏è‚É£ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ Nginx..."
sudo tail -20 /var/log/nginx/error.log
echo ""

# 8. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo ""
echo "=========================================="
echo "üéØ –ß–¢–û –î–ï–õ–ê–¢–¨:"
echo "=========================================="
echo ""
echo "–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ:"
echo "  pm2 start ecosystem.config.js"
echo ""
echo "–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç:"
echo "  pm2 logs nesi-app --lines 100"
echo ""
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
echo "  pm2 restart nesi-app"
echo ""
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx:"
echo "  sudo systemctl restart nginx"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx:"
echo "  sudo nginx -t"
echo ""

