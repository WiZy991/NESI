# üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¢-–ë–∞–Ω–∫ –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã

## üéØ –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

**–û—à–∏–±–∫–∏:**

1. ‚ùå `POST /api/wallet/tbank/create-payment 500 (Internal Server Error)`
2. ‚ùå `–ù–µ –Ω–∞–π–¥–µ–Ω DealId –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã`

**–ü—Ä–∏—á–∏–Ω—ã:**

1. –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`TBANK_TERMINAL_KEY`, `TBANK_PASSWORD`)
2. –ù–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è `dealId`, `paymentId`)
3. –í–µ–±—Ö—É–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞

---

## ‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ (3 –∫–æ–º–∞–Ω–¥—ã)

### 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª .env
nano .env

# –î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è):
TBANK_TERMINAL_KEY="–≤–∞—à_terminal_key_–æ—Ç_—Ç–±–∞–Ω–∫–∞"
TBANK_PASSWORD="–≤–∞—à_password_–æ—Ç_—Ç–±–∞–Ω–∫–∞"
TBANK_E2C_TERMINAL_KEY="–≤–∞—à_e2c_terminal_key"  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
NEXT_PUBLIC_APP_URL="https://nesi.su"

# –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: Ctrl+O, Enter, Ctrl+X
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Prisma (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```bash
cd NESI
npx prisma migrate deploy
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ psql**

```bash
cd NESI
psql $DATABASE_URL -f prisma/migrations/20241119_add_dealid_paymentid/migration.sql
```

**–í–∞—Ä–∏–∞–Ω—Ç C: –ù–∞–ø—Ä—è–º—É—é SQL**

```bash
psql $DATABASE_URL << 'EOF'
ALTER TABLE "Transaction" ADD COLUMN IF NOT EXISTS "dealId" TEXT;
ALTER TABLE "Transaction" ADD COLUMN IF NOT EXISTS "paymentId" TEXT;
CREATE INDEX IF NOT EXISTS "Transaction_dealId_idx" ON "Transaction"("dealId");
CREATE INDEX IF NOT EXISTS "Transaction_paymentId_idx" ON "Transaction"("paymentId");
EOF
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
# PM2
pm2 restart all --update-env

# Docker
docker-compose restart

# –ù–∞–ø—Ä—è–º—É—é
npm run build
npm start
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
cd NESI
node -e "require('dotenv').config(); console.log('TBANK_TERMINAL_KEY:', process.env.TBANK_TERMINAL_KEY ? '‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); console.log('TBANK_PASSWORD:', process.env.TBANK_PASSWORD ? '‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**

```
TBANK_TERMINAL_KEY: ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
TBANK_PASSWORD: ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

```bash
psql $DATABASE_URL -c "SELECT column_name FROM information_schema.columns WHERE table_name = 'Transaction' AND column_name IN ('dealId', 'paymentId');"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**

```
 column_name
-------------
 dealId
 paymentId
(2 rows)
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±—Ö—É–∫–∞

```bash
curl https://nesi.su/api/wallet/tbank/webhook
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**

```json
{
	"status": "ok",
	"message": "Webhook is available. Use POST method to send notifications.",
	"endpoint": "/api/wallet/tbank/webhook",
	"method": "POST"
}
```

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Å–∫—Ä–∏–ø—Ç)

```bash
cd NESI
node scripts/check-tbank-setup.js
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://nesi.su/wallet
2. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"**
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É: **10 ‚ÇΩ**
4. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–ø–æ–ª–Ω–∏—Ç—å"**
5. –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π –¢-–ë–∞–Ω–∫–∞

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**

- ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã –¢-–ë–∞–Ω–∫–∞
- ‚úÖ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–∞–π—Ç
- ‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

```bash
# PM2
pm2 logs --lines 50 | grep -E "WEBHOOK|CREATE-PAYMENT"

# Docker
docker logs your-container --tail 50 | grep -E "WEBHOOK|CREATE-PAYMENT"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```
üì• [WEBHOOK] –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç T-Bank
üìä [WEBHOOK] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞—Ç–µ–∂–∞: { Status: 'CONFIRMED', SpAccumulationId: 123456 }
üí∞ [WEBHOOK] –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ: { dealId: '123456', ... }
‚úÖ [WEBHOOK] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ DealId –≤ –ë–î

```bash
psql $DATABASE_URL -c "SELECT id, type, amount, dealId, paymentId, createdAt FROM \"Transaction\" WHERE type = 'deposit' ORDER BY createdAt DESC LIMIT 3;"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**

```
      id       | type    | amount | dealId  | paymentId | createdAt
---------------+---------+--------+---------+-----------+------------
 clxxx...      | deposit | 10.00  | 123456  | 789012    | 2024-11-19...
```

### –¢–µ—Å—Ç –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://nesi.su/wallet
2. –ù–∞–∂–º–∏—Ç–µ **"–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞"**
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É: **100 ‚ÇΩ**
4. –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (–∫–∞—Ä—Ç–∞ –∏–ª–∏ –°–ë–ü)
5. –ù–∞–∂–º–∏—Ç–µ **"–í—ã–≤–µ—Å—Ç–∏"**

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**

- ‚úÖ –í—ã–≤–æ–¥ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–∫–∏ "–ù–µ –Ω–∞–π–¥–µ–Ω DealId"

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤ –¢-–ë–∞–Ω–∫–µ

1. **–û—Ç–∫—Ä–æ–π—Ç–µ:** https://business.tbank.ru/
2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ:** –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥ ‚Üí –í–∞—à —Ç–µ—Ä–º–∏–Ω–∞–ª ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏
3. **–ù–∞–π–¥–∏—Ç–µ:** –†–∞–∑–¥–µ–ª "–í–µ–±—Ö—É–∫–∏" –∏–ª–∏ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
4. **–£–∫–∞–∂–∏—Ç–µ URL:**
   ```
   https://nesi.su/api/wallet/tbank/webhook
   ```
5. **–ú–µ—Ç–æ–¥:** POST
6. **–§–æ—Ä–º–∞—Ç:** JSON
7. **–£–±–µ–¥–∏—Ç–µ—Å—å:** –í–µ–±—Ö—É–∫ –∞–∫—Ç–∏–≤–µ–Ω (–≤–∫–ª—é—á–µ–Ω)

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ IP –¢-–ë–∞–Ω–∫–∞ –≤ whitelist (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```bash
# –î–ª—è UFW
sudo ufw allow from 185.71.76.0/27
sudo ufw allow from 185.71.77.0/27

# –î–ª—è iptables
sudo iptables -A INPUT -s 185.71.76.0/27 -j ACCEPT
sudo iptables -A INPUT -s 185.71.77.0/27 -j ACCEPT
```

---

## üÜò –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "TBANK_TERMINAL_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ .env
ls -la .env

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (—Å–∫—Ä—ã–≤–∞—è –∑–Ω–∞—á–µ–Ω–∏—è)
grep TBANK .env | sed 's/=.*/=***/'

# –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–π—Ç–µ
cp .env.example .env
nano .env
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é DATABASE_URL
echo $DATABASE_URL

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
psql $DATABASE_URL -c "SELECT 1;"

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
sudo systemctl status postgresql
```

### –ü—Ä–æ–±–ª–µ–º–∞: –í–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ:**

```bash
# PM2
pm2 list

# Docker
docker ps

# Curl
curl -I https://nesi.su/
```

**2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ nginx/apache –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:**

```bash
# Nginx
sudo nginx -t
sudo systemctl status nginx

# Apache
sudo apache2ctl -t
sudo systemctl status apache2
```

**3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π—Ä–≤–æ–ª:**

```bash
# UFW
sudo ufw status

# Iptables
sudo iptables -L -n
```

**4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–µ–±—Ö—É–∫–∞:**

```bash
pm2 logs | grep WEBHOOK
```

–ï—Å–ª–∏ –ª–æ–≥–æ–≤ –Ω–µ—Ç - –≤–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç –¢-–ë–∞–Ω–∫–∞.

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —Å—á–∏—Ç–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π:

- [ ] ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `.env`
- [ ] ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (–ø–æ–ª—è `dealId`, `paymentId` —Å–æ–∑–¥–∞–Ω—ã)
- [ ] ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
- [ ] ‚úÖ –í–µ–±—Ö—É–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞
- [ ] ‚úÖ –í–µ–±—Ö—É–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ URL (GET –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200)
- [ ] ‚úÖ IP –¢-–ë–∞–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ whitelist (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
- [ ] ‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [ ] ‚úÖ –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –≤–µ–±—Ö—É–∫–∞
- [ ] ‚úÖ DealId —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- [ ] ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- [–ù–ê–°–¢–†–û–ô–ö–ê*–¢–ë–ê–ù–ö*–ü–û–õ–ù–ê–Ø.md](./–ù–ê–°–¢–†–û–ô–ö–ê_–¢–ë–ê–ù–ö_–ü–û–õ–ù–ê–Ø.md) - –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- [–ë–´–°–¢–†–û–ï*–†–ï–®–ï–ù–ò–ï*–ü–†–û–ë–õ–ï–ú–´.md](./–ë–´–°–¢–†–û–ï_–†–ï–®–ï–ù–ò–ï_–ü–†–û–ë–õ–ï–ú–´.md) - –≠–∫—Å–ø—Ä–µ—Å—Å-—Ä–µ—à–µ–Ω–∏–µ
- [TBANK_SETUP.md](./TBANK_SETUP.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [multisplit.md](./multisplit.md) - –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–¢-–ë–∞–Ω–∫:**

- Email: acq_help@tbank.ru
- –í–æ–ø—Ä–æ—Å: "–ü–æ—á–µ–º—É –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç SpAccumulationId –≤ –≤–µ–±—Ö—É–∫–µ?"

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**

- https://www.tbank.ru/kassa/dev/

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 5-10 –º–∏–Ω—É—Ç  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 19 –Ω–æ—è–±—Ä—è 2024
