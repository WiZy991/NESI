# ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ nesi.su

## üéØ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ –ø–∞–ø–∫–µ `NESI/`:

```bash
# === –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ===
DATABASE_URL="postgresql://user:password@localhost:5432/nesi"
JWT_SECRET="–≤–∞—à_jwt_—Å–µ–∫—Ä–µ—Ç"

# === URL —Å–∞–π—Ç–∞ ===
NEXT_PUBLIC_BASE_URL="https://nesi.su"

# === –¢-–ë–∞–Ω–∫ –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã ===

# –¢–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π (–æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π)
TBANK_TERMINAL_KEY="TinkoffBankTest"
TBANK_TERMINAL_PASSWORD="–≤–∞—à_–ø–∞—Ä–æ–ª—å_–æ—Ç_—Ç–±–∞–Ω–∫–∞"

# E2C —Ç–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è –≤—ã–ø–ª–∞—Ç (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º)
TBANK_E2C_TERMINAL_KEY="TerminalKeyE2C"
TBANK_E2C_TERMINAL_PASSWORD="–≤–∞—à_e2c_–ø–∞—Ä–æ–ª—å"

# –†–µ–∂–∏–º: test –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, production –¥–ª—è –±–æ–µ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
TBANK_MODE="test"
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ:**

- –ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ –ø–∞—Ä–æ–ª–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ç –¢-–ë–∞–Ω–∫–∞
- –î–ª—è production —Å–º–µ–Ω–∏—Ç–µ `TBANK_MODE="production"`

---

## üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢-–ë–∞–Ω–∫–∞ –¥–ª—è nesi.su

### Notification URL (webhook)

–í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ [business.tbank.ru](https://business.tbank.ru):

```
https://nesi.su/api/tbank/webhook
```

### Success/Fail URLs

```
Success URL: https://nesi.su/profile?payment=success
Fail URL: https://nesi.su/profile?payment=failed
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### IP Whitelist

–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞ `acq_help@tbank.ru` —Å –ø—Ä–æ—Å—å–±–æ–π –¥–æ–±–∞–≤–∏—Ç—å IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ nesi.su –≤ whitelist.

### Firewall

–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç IP –¢-–ë–∞–Ω–∫–∞:

```bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ firewall –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è:
91.194.226.0/23
91.218.132.0/22
212.233.80.0/22
```

**–î–ª—è UFW (Ubuntu):**

```bash
sudo ufw allow from 91.194.226.0/23 to any port 443
sudo ufw allow from 91.218.132.0/22 to any port 443
sudo ufw allow from 212.233.80.0/22 to any port 443
```

---

## üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä

### –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ nesi.su
cd /path/to/nesi
git pull origin main
```

### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
cd NESI
npm install
```

### –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
npx prisma migrate deploy
npx prisma generate
```

**‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `migrate deploy` –Ω–∞ production, –∞ –Ω–µ `migrate dev`!**

### –®–∞–≥ 4: –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç

```bash
npm run build
```

### –®–∞–≥ 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ PM2:
pm2 restart nesi

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ systemd:
sudo systemctl restart nesi

# –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ:
npm start
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω

```bash
curl https://nesi.su
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint —Å—Ç–∞—Ç—É—Å–∞

```bash
curl https://nesi.su/api/tbank/status
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:

```json
{
	"configured": true,
	"missing": [],
	"mode": "test",
	"baseUrl": "https://rest-api-test.tinkoff.ru"
}
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook endpoint

```bash
curl -X POST https://nesi.su/api/tbank/webhook \
  -H "Content-Type: application/json" \
  -d '{"test": "ping"}'
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `OK` (–¥–∞–∂–µ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, —Ç.–∫. –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç OK –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ)

### 4. –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ `https://nesi.su/profile`
2. –í–∫–ª–∞–¥–∫–∞ "–ö–æ—à–µ–ª–µ–∫"
3. "–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"
4. –í–≤–µ–¥–∏—Ç–µ 100 ‚ÇΩ
5. –î–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ñ–æ—Ä–º—É –¢-–ë–∞–Ω–∫–∞

---

## üêõ Troubleshooting –¥–ª—è nesi.su

### –û—à–∏–±–∫–∞ "Cannot connect to database"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ DATABASE_URL:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
psql -U user -d nesi -c "SELECT 1;"
```

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `https://nesi.su/api/tbank/webhook` –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall (–ø–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç?)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:

```bash
# PM2 –ª–æ–≥–∏
pm2 logs nesi

# –ò–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
tail -f /var/log/nginx/error.log
```

### –û—à–∏–±–∫–∞ SSL/HTTPS

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è nesi.su —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
curl -vI https://nesi.su 2>&1 | grep -i "SSL\|certificate"
```

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è nesi.su

- [ ] –ö–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] `.env` —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
- [ ] `NEXT_PUBLIC_BASE_URL="https://nesi.su"`
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (`npx prisma migrate deploy`)
- [ ] –ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω (`npm run build`)
- [ ] –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω: `https://nesi.su/api/tbank/webhook`
- [ ] Success URL: `https://nesi.su/profile?payment=success`
- [ ] Fail URL: `https://nesi.su/profile?payment=failed`
- [ ] IP —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω –≤ whitelist –¢-–ë–∞–Ω–∫–∞
- [ ] IP –¢-–ë–∞–Ω–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤ firewall
- [ ] SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∞–∫—Ç–∏–≤–µ–Ω
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –≤—ã–≤–æ–¥

---

## üîë –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¢-–ë–∞–Ω–∫–∞

### –î–ª—è nesi.su –Ω—É–∂–Ω–æ:

1. **–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É** –Ω–∞ [tbank.ru/kassa](https://tbank.ru/kassa)
2. **–£–∫–∞–∑–∞—Ç—å –≤ –∑–∞—è–≤–∫–µ:**

   - –°–∞–π—Ç: `https://nesi.su`
   - –ü—Ä–æ–¥—É–∫—Ç: –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã
   - Email –¥–ª—è —Å–≤—è–∑–∏
   - –ò–ù–ù/–û–ì–†–ù (–µ—Å–ª–∏ —é—Ä.–ª–∏—Ü–æ)

3. **–ü–æ–ª—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:**

   - TerminalKey (–¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π)
   - Password
   - TerminalKeyE2C (–¥–ª—è –≤—ã–ø–ª–∞—Ç)
   - PasswordE2C

4. **–í–Ω–µ—Å–∏—Ç–µ –≤ `.env`** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ nesi.su

### –õ–æ–≥–∏

```bash
# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pm2 logs nesi --lines 100

# –°–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
pm2 logs nesi --err

# –õ–æ–≥–∏ –¢-–ë–∞–Ω–∫–∞ (grep)
pm2 logs nesi | grep "TBank"
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql -U user -d nesi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–¥–µ–ª–∫–∏
SELECT id, "spAccumulationId", status, "totalAmount", "createdAt"
FROM "TBankDeal"
ORDER BY "createdAt" DESC
LIMIT 5;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏
SELECT "paymentId", amount, status, "createdAt"
FROM "TBankPayment"
ORDER BY "createdAt" DESC
LIMIT 10;
```

---

## üéØ Production –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–ª—è nesi.su

### –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. –°–º–µ–Ω–∏—Ç–µ —Ä–µ–∂–∏–º:

```bash
# –í .env
TBANK_MODE="production"
```

2. –ü–æ–ª—É—á–∏—Ç–µ –±–æ–µ–≤—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –¢-–ë–∞–Ω–∫–∞

3. –û–±–Ω–æ–≤–∏—Ç–µ `.env` —Å –±–æ–µ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏

4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å

5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —Å—É–º–º–∞—Ö!

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–¢-–ë–∞–Ω–∫:**

- üìß acq_help@tbank.ru
- üåê developer.tbank.ru
- üíº business.tbank.ru

**–í–∞—à —Å–∞–π—Ç:** https://nesi.su  
**Webhook:** https://nesi.su/api/tbank/webhook  
**–ü—Ä–æ—Ñ–∏–ª—å:** https://nesi.su/profile

---

‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ –Ω–∞ nesi.su!**
