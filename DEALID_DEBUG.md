# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å DealId

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª–µ `dealId` –≤ —Ç–∞–±–ª–∏—Ü–µ `Transaction` –æ—Å—Ç–∞–µ—Ç—Å—è `NULL`, —Ö–æ—Ç—è `paymentId` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è.

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

1. **DealId –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≤–µ–±—Ö—É–∫–µ** - –¢-–ë–∞–Ω–∫ –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å DealId –≤ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **DealId –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–µ Init** - –≤–æ–∑–º–æ–∂–Ω–æ, —Å–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
3. **DealId –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –¥—Ä—É–≥–æ–º –ø–æ–ª–µ** - –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ø–æ–ª—è –≤–µ–±—Ö—É–∫–∞

## –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –≤—ã —É–≤–∏–¥–∏—Ç–µ:

- `üí≥ [CREATE-PAYMENT]` - –≤—Å–µ –ø–æ–ª—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –¢-–ë–∞–Ω–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
- `üì• [WEBHOOK]` - –ø–æ–ª–Ω–æ–µ —Ç–µ–ª–æ –≤–µ–±—Ö—É–∫–∞ –∏ –≤—Å–µ –ø–æ–ª—è
- `üîç [WEBHOOK] –ü–æ–∏—Å–∫ DealId` - –ø–æ–∏—Å–∫ DealId –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª—è—Ö
- `‚úÖ [WEBHOOK] DealId –ø–æ–ª—É—á–µ–Ω –∏–∑ API` - –µ—Å–ª–∏ DealId –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ GetState

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ DealId

–ï—Å–ª–∏ DealId –Ω–µ –ø—Ä–∏—à–µ–ª –≤ –≤–µ–±—Ö—É–∫–µ, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ API GetState
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
3. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### 3. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞

–ï—Å–ª–∏ DealId –≤—Å–µ –µ—â–µ NULL –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å–∏—Å—Ç–µ–º–∞ –¥–µ–ª–∞–µ—Ç –µ—â–µ –æ–¥–Ω—É –ø–æ–ø—ã—Ç–∫—É –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ API.

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞

–ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:

```
üí≥ [CREATE-PAYMENT] –û—Ç–≤–µ—Ç –æ—Ç –¢-–ë–∞–Ω–∫–∞:
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ —Ç–∞–º `dealId`, `receivedDealId` –∏–ª–∏ `receivedSpAccumulationId`.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–µ–±—Ö—É–∫–∞

–ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:

```
üì• [WEBHOOK] –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–ª–Ω–æ–µ):
üîç [WEBHOOK] –ü–æ–∏—Å–∫ DealId –≤–æ –≤—Å–µ—Ö –ø–æ–ª—è—Ö:
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–∏–µ –ø–æ–ª—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –≤–µ–±—Ö—É–∫–µ.

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

```sql
SELECT
  id,
  type,
  amount,
  "dealId",
  "paymentId",
  reason,
  "createdAt"
FROM "Transaction"
WHERE type = 'deposit'
ORDER BY "createdAt" DESC
LIMIT 5;
```

## –†–µ—à–µ–Ω–∏–µ

### –ï—Å–ª–∏ DealId –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≤–µ–±—Ö—É–∫–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂" –≤ –ø—Ä–æ—Ñ–∏–ª–µ - –æ–Ω–∞ –æ–±–Ω–æ–≤–∏—Ç DealId —á–µ—Ä–µ–∑ API GetState.

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ API:

```bash
curl -X POST https://YOUR_DOMAIN/api/wallet/tbank/update-deal-ids \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### –ï—Å–ª–∏ DealId –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ Init

–í–æ–∑–º–æ–∂–Ω–æ, –¢-–ë–∞–Ω–∫ —Å–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ:

1. –í–µ–±—Ö—É–∫ –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å DealId –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
2. –ï—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ GetState API

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¢-–ë–∞–Ω–∫–∞

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:

1. ‚úÖ –¢–µ—Ä–º–∏–Ω–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç–∞–º–∏
2. ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `CreateDealWithType = 'NN'` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Init
3. ‚úÖ –í–µ–±—Ö—É–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –µ—â–µ —Ä–∞–∑ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏. –ü—Ä–∏—à–ª–∏—Ç–µ –ª–æ–≥–∏, –µ—Å–ª–∏ DealId –≤—Å–µ –µ—â–µ NULL.
