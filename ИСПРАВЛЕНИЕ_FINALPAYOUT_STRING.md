# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ FinalPayout

**–î–∞—Ç–∞:** 20 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ 322 "–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã" –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —á–µ—Ä–µ–∑ –°–ë–ü

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ –°–ë–ü T-Bank API –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É 322 –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `FinalPayout`.

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**

```typescript
requestBody.FinalPayout = true // ‚Üê Boolean –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏
```

**–í –∑–∞–ø—Ä–æ—Å–µ –∫ API:**

```json
{
	"FinalPayout": true, // ‚Üê JSON boolean
	"Token": "..."
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ T-Bank A2C_V2 (—Å—Ç—Ä. 903), –ø–∞—Ä–∞–º–µ—Ç—Ä `FinalPayout` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **—Å—Ç—Ä–æ–∫–æ–π**, –∞ –Ω–µ boolean.

---

## üìù –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –ü—Ä–∏–º–µ—Ä –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ A2C_V2 (—Å—Ç—Ä. 900-906):

```json
{
	"TerminalKey": "TerminalKeyE2C",
	"OrderId": "testSBP 10",
	"Phone": "79998887766",
	"SbpMemberId": "100000000004",
	"FinalPayout": "true", // ‚Üê –°–¢–†–û–ö–ê, –∞ –Ω–µ boolean!
	"Amount": 100,
	"DealId": "9043456",
	"PaymentRecipientId": "79066589133",
	"Token": "..."
}
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `FinalPayout` —Å `boolean` –Ω–∞ `string`:

### –§–∞–π–ª: `src/lib/tbank.ts`

**–ë—ã–ª–æ:**

```typescript
// –§–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞
if (params.finalPayout) {
	requestBody.FinalPayout = true // ‚Üê Boolean
}
```

**–°—Ç–∞–ª–æ:**

```typescript
// –§–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞
if (params.finalPayout) {
	requestBody.FinalPayout = 'true' // ‚Üê –°—Ç—Ä–æ–∫–∞ (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ A2C_V2 —Å—Ç—Ä. 903)
}
```

### –§–∞–π–ª: `test-signature.js`

**–ë—ã–ª–æ:**

```javascript
const requestBody = {
	// ...
	FinalPayout: true, // ‚Üê Boolean
	// ...
}
```

**–°—Ç–∞–ª–æ:**

```javascript
const requestBody = {
	// ...
	FinalPayout: 'true', // ‚Üê –°—Ç—Ä–æ–∫–∞ (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ A2C_V2 —Å—Ç—Ä. 903)
	// ...
}
```

---

## üîç –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–¥–ø–∏—Å—å (Token)

–ö–æ–≥–¥–∞ `FinalPayout` —è–≤–ª—è–µ—Ç—Å—è boolean, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```
...56868517truehttps://nesi.su/api/wallet/tbank/webhook...
         ^^^^ (boolean true –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É "true")
```

–ö–æ–≥–¥–∞ `FinalPayout` —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π, –æ–Ω–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ "true", –Ω–æ:

1. **JSON.stringify()** –≤—ã–≤–æ–¥–∏—Ç –µ—ë –ø–æ-–¥—Ä—É–≥–æ–º—É
2. **T-Bank API** –º–æ–∂–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –†–µ–∑—É–ª—å—Ç–∞—Ç:

- ‚ùå **Boolean:** `{"FinalPayout": true}` ‚Üí T-Bank –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–∫ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø
- ‚úÖ **–°—Ç—Ä–æ–∫–∞:** `{"FinalPayout": "true"}` ‚Üí T-Bank –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:

```bash
cd /path/to/nesi-app

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev-—Å–µ—Ä–≤–µ—Ä
npm run dev
```

### 2. –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ:

```bash
cd ~/nesi-app

# –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull

# –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
sudo systemctl restart nesi-app.service

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo journalctl -u nesi-app.service -f
```

---

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å –∫ T-Bank –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

**–ë—ã–ª–æ (—Å –æ—à–∏–±–∫–æ–π 322):**

```json
{
	"TerminalKey": "1763372956356E2C",
	"Amount": 10000,
	"OrderId": "withdraw_...",
	"DealId": "56868517",
	"PaymentRecipientId": "79662765973",
	"Phone": "79662765973",
	"SbpMemberId": "100000000111",
	"FinalPayout": true, // ‚Üê ‚ùå Boolean
	"NotificationURL": "https://nesi.su/api/wallet/tbank/webhook",
	"Token": "..."
}
```

**–°—Ç–∞–ª–æ (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å):**

```json
{
	"TerminalKey": "1763372956356E2C",
	"Amount": 10000,
	"OrderId": "withdraw_...",
	"DealId": "56868517",
	"PaymentRecipientId": "79662765973",
	"Phone": "79662765973",
	"SbpMemberId": "100000000111",
	"FinalPayout": "true", // ‚Üê ‚úÖ –°—Ç—Ä–æ–∫–∞
	"NotificationURL": "https://nesi.su/api/wallet/tbank/webhook",
	"Token": "..."
}
```

---

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–ø–ª–∞—Ç—ã:

```bash
sudo journalctl -u nesi-app.service --since "1 minute ago" --no-pager | grep -E "CREATE-WITHDRAWAL|TBANK"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```
üì§ [TBANK] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É: {
  "FinalPayout": "true",  // ‚Üê –°—Ç—Ä–æ–∫–∞!
  ...
}

üì• [TBANK] –û—Ç–≤–µ—Ç –æ—Ç API: {
  success: true,
  errorCode: '0',
  paymentId: 'XXXXXXXX',
  status: 'COMPLITING'
}
```

### 2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—ã–ø–ª–∞—Ç—É:

1. –í–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ù–∞–∂–º–∏—Ç–µ "–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞"
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–º–∏–Ω–∏–º—É–º 100 ‚ÇΩ)
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±: –°–ë–ü
5. –ù–∞–∂–º–∏—Ç–µ "–í—ã–≤–µ—Å—Ç–∏"

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**

- ‚úÖ –í—ã–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ –ë–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–∏–ª—Å—è –Ω–∞ —Å—É–º–º—É –≤—ã–ø–ª–∞—Ç—ã
- ‚úÖ –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ—à–∏–±–∫–∏ 322

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/lib/tbank.ts` (—Å—Ç—Ä–æ–∫–∞ 355) - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã
- `test-signature.js` (—Å—Ç—Ä–æ–∫–∞ 17) - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏
- `vyplaty-multisplit.md` (—Å—Ç—Ä–æ–∫–∞ 903) - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è T-Bank

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ü–æ—á–µ–º—É –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è?

–í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ T-Bank –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –ø—Ä–∏–º–µ—Ä—ã —Å –æ–±–æ–∏–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:

- `"FinalPayout": "true"` (—Å—Ç—Ä–æ–∫–∞) - **–ø—Ä–∞–≤–∏–ª—å–Ω–æ** ‚úÖ
- `"FinalPayout": true` (boolean) - **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** ‚ùå

**–ü—Ä–∏—á–∏–Ω–∞:** T-Bank API —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –±—É–ª–µ–≤—ã.

### –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

–î—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ —Ç–∏–ø–∞:

- `Amount` - –≤—Å–µ–≥–¥–∞ —á–∏—Å–ª–æ (–Ω–µ —Å—Ç—Ä–æ–∫–∞)
- `CreateDealWithType` - –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞
- `LevelOfConfidence` - –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∞ ("moderate", "high", etc.)

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –°–ë–ü –¥–æ–ª–∂–Ω—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å!
