# üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è E2C —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (–í—ã–ø–ª–∞—Ç—ã)

**–î–∞—Ç–∞:** 20 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ 322 "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å" –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —á–µ—Ä–µ–∑ E2C —Ç–µ—Ä–º–∏–Ω–∞–ª

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ E2C —Ç–µ—Ä–º–∏–Ω–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏:

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –æ—Ç EACQ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (–¥–ª—è –æ–ø–ª–∞—Ç)
requestBody.Token = generateToken(requestBody) // –í—Å–µ–≥–¥–∞ TBANK_PASSWORD
```

**–û—à–∏–±–∫–∞:**

- –î–ª—è **–æ–ø–ª–∞—Ç (EACQ)** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Ä–º–∏–Ω–∞–ª `1763372956356` —Å –ø–∞—Ä–æ–ª–µ–º `TBANK_PASSWORD`
- –î–ª—è **–≤—ã–ø–ª–∞—Ç (E2C)** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Ä–º–∏–Ω–∞–ª `1763372956356E2C` —Å –ø–∞—Ä–æ–ª–µ–º `TBANK_E2C_PASSWORD`
- –§—É–Ω–∫—Ü–∏—è `generateToken` **–≤—Å–µ–≥–¥–∞** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `TBANK_PASSWORD`, –¥–∞–∂–µ –¥–ª—è E2C –∑–∞–ø—Ä–æ—Å–æ–≤

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `generateToken` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤.

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `generateToken`:

**–ë—ã–ª–æ:**

```typescript
export function generateToken(params: Record<string, any>): string {
	const password = process.env.TBANK_PASSWORD
	if (!password) {
		throw new Error('TBANK_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è')
	}
	// ...
}
```

**–°—Ç–∞–ª–æ:**

```typescript
export function generateToken(
	params: Record<string, any>,
	password?: string // ‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ø–∞—Ä–æ–ª—å —è–≤–Ω–æ
): string {
	const terminalPassword =
		password || process.env.TBANK_PASSWORD || process.env.TBANK_E2C_PASSWORD
	if (!terminalPassword) {
		throw new Error(
			'TBANK_PASSWORD –∏–ª–∏ TBANK_E2C_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è'
		)
	}
	// ...
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `createWithdrawal`:

**–ë—ã–ª–æ:**

```typescript
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Token
requestBody.Token = generateToken(requestBody) // ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç TBANK_PASSWORD
```

**–°—Ç–∞–ª–æ:**

```typescript
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Token —Å –ø–∞—Ä–æ–ª–µ–º E2C —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
const e2cPassword = process.env.TBANK_E2C_PASSWORD
if (!e2cPassword) {
	throw new Error('TBANK_E2C_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è')
}

requestBody.Token = generateToken(requestBody, e2cPassword) // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º E2C –ø–∞—Ä–æ–ª—å
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `confirmWithdrawal`:

**–ë—ã–ª–æ:**

```typescript
requestBody.Token = generateToken(requestBody) // ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç TBANK_PASSWORD
```

**–°—Ç–∞–ª–æ:**

```typescript
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Token —Å –ø–∞—Ä–æ–ª–µ–º E2C —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
const e2cPassword = process.env.TBANK_E2C_PASSWORD
if (!e2cPassword) {
	throw new Error('TBANK_E2C_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è')
}

requestBody.Token = generateToken(requestBody, e2cPassword) // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º E2C –ø–∞—Ä–æ–ª—å
```

---

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### –§–∞–π–ª: `src/lib/tbank.ts`

1. **–°—Ç—Ä–æ–∫–∞ 21-40:** –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `password` –≤ —Ñ—É–Ω–∫—Ü–∏—é `generateToken`
2. **–°—Ç—Ä–æ–∫–∞ 344-362:** –í `createWithdrawal` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `TBANK_E2C_PASSWORD` –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –≤ `generateToken`
3. **–°—Ç—Ä–æ–∫–∞ 467-477:** –í `confirmWithdrawal` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `TBANK_E2C_PASSWORD` –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –≤ `generateToken`

---

## üîë –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–¢–µ–ø–µ—Ä—å —Ç—Ä–µ–±—É—é—Ç—Å—è **–î–í–ê** —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ä–æ–ª—è:

### –î–ª—è –æ–ø–ª–∞—Ç (EACQ —Ç–µ—Ä–º–∏–Ω–∞–ª):

```env
TBANK_TERMINAL_KEY=1763372956356
TBANK_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å_–¥–ª—è_–æ–ø–ª–∞—Ç
```

### –î–ª—è –≤—ã–ø–ª–∞—Ç (E2C —Ç–µ—Ä–º–∏–Ω–∞–ª):

```env
TBANK_E2C_TERMINAL_KEY=1763372956356E2C
TBANK_E2C_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å_–¥–ª—è_–≤—ã–ø–ª–∞—Ç
```

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
cd ~/nesi-app

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ E2C –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
grep -E "TBANK_E2C_" .env

# –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤—å—Ç–µ:
# TBANK_E2C_TERMINAL_KEY=1763372956356E2C
# TBANK_E2C_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å_–æ—Ç_E2C_—Ç–µ—Ä–º–∏–Ω–∞–ª–∞

# –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull

# –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
sudo systemctl restart nesi-app.service

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo journalctl -u nesi-app.service -f
```

---

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
üì§ [TBANK] –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã:
  url: https://securepay.tinkoff.ru/e2c/v2/Init/
  terminalKey: 1763372956356E2C (E2C —Ç–µ—Ä–º–∏–Ω–∞–ª)
  token: <—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å TBANK_PASSWORD>  ‚Üê ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!

üì• [TBANK] –û—Ç–≤–µ—Ç –æ—Ç API:
  errorCode: '322'
  message: '–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.' (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å)
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
üì§ [TBANK] –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã:
  url: https://securepay.tinkoff.ru/e2c/v2/Init/
  terminalKey: 1763372956356E2C (E2C —Ç–µ—Ä–º–∏–Ω–∞–ª)
  token: <—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å TBANK_E2C_PASSWORD>  ‚Üê ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!

üì• [TBANK] –û—Ç–≤–µ—Ç –æ—Ç API:
  success: true
  errorCode: '0'
  paymentId: 'XXXXXXXX'
  ‚úÖ –í—ã–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
sudo journalctl -u nesi-app.service --since "1 minute ago" --no-pager | grep -E "CREATE-WITHDRAWAL|TBANK|Success"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```
üí∏ [CREATE-WITHDRAWAL] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–ø–ª–∞—Ç—ã: {
  dealId: '56868517',
  phone: '79662765973',
  sbpMemberId: '100000000004'
}
üì§ [TBANK] –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã: {
  url: 'https://securepay.tinkoff.ru/e2c/v2/Init/',
  terminalKey: '1763372956356E2C'
}
üì• [TBANK] –û—Ç–≤–µ—Ç –æ—Ç API: {
  success: true,
  errorCode: '0',
  paymentId: 'XXXXXXXX'
}
‚úÖ –í—ã–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!
```

---

## üìù –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ A2C_V2

### –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏:

1. –í–∑—è—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
2. –î–æ–±–∞–≤–∏—Ç—å `Password` —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
3. –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
4. –ö–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è
5. –í—ã—á–∏—Å–ª–∏—Ç—å SHA-256

**–î–ª—è E2C —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å E2C –ø–∞—Ä–æ–ª—å!**

---

## üéØ –ò—Ç–æ–≥–æ

| –¢–µ—Ä–º–∏–Ω–∞–ª      | TerminalKey        | Password             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ    |
| ------------- | ------------------ | -------------------- | ------------- |
| EACQ (–û–ø–ª–∞—Ç—ã) | `1763372956356`    | `TBANK_PASSWORD`     | –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ    |
| E2C (–í—ã–ø–ª–∞—Ç—ã) | `1763372956356E2C` | `TBANK_E2C_PASSWORD` | –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ |

**–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–æ–ª—å —Ç–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –¥–µ–ª–∞–µ—Ç–µ –∑–∞–ø—Ä–æ—Å!

---

**–ì–æ—Ç–æ–≤–æ!** –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å! üéâ
