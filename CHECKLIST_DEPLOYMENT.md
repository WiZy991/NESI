# ✅ Чеклист для деплоя системы платежей

## Перед деплоем на сервер

### 1. База данных

- [ ] Создать бэкап текущей БД
- [ ] Применить миграцию: `npx prisma migrate deploy`
- [ ] Проверить, что все поля имеют тип Decimal:
  ```sql
  \d "User"  -- Проверить balance, frozenBalance
  \d "Task"  -- Проверить price, escrowAmount
  \d "Transaction"  -- Проверить amount
  ```

### 2. Переменные окружения

- [ ] Добавить `YOOKASSA_SHOP_ID`
- [ ] Добавить `YOOKASSA_SECRET_KEY`
- [ ] Установить `NEXT_PUBLIC_BASE_URL` на продакшен URL
- [ ] Проверить все переменные: `cat .env | grep YOOKASSA`

### 3. ЮKassa настройки

- [ ] Зарегистрироваться на https://yookassa.ru/
- [ ] Создать магазин
- [ ] Получить токены (Shop ID и Secret Key)
- [ ] Настроить вебхук:
  - URL: `https://yourdomain.com/api/wallet/yookassa-webhook`
  - Событие: `payment.succeeded`
- [ ] Проверить IP whitelist (опционально)

### 4. Код

- [ ] Закоммитить все изменения
- [ ] Запушить на сервер
- [ ] Запустить `npm install` (на всякий случай)
- [ ] Запустить `npx prisma generate`
- [ ] Перезапустить приложение

### 5. Тестирование на продакшене

- [ ] Проверить `/api/wallet/balance` - должен вернуть баланс
- [ ] Создать тестовый платеж на 1 ₽
- [ ] Проверить, что редирект на ЮKassa работает
- [ ] Оплатить тестовой картой: `5555 5555 5555 4477`
- [ ] Проверить, что средства зачислились
- [ ] Проверить логи сервера на наличие ошибок
- [ ] Попробовать взять задачу с недостаточным балансом
- [ ] Попробовать взять задачу с достаточным балансом

### 6. Мониторинг

- [ ] Настроить мониторинг вебхуков ЮKassa
- [ ] Настроить алерты на ошибки в `/api/wallet/*`
- [ ] Проверить логи транзакций в БД
- [ ] Настроить Sentry или аналог для отслеживания ошибок

## После деплоя

### Проверка функционала

- [ ] Пополнение баланса работает
- [ ] Баланс корректно отображается (с копейками)
- [ ] Нельзя взять задачу с недостаточным балансом
- [ ] Замороженный баланс учитывается
- [ ] При завершении задачи деньги переводятся исполнителю
- [ ] Комиссия 20% рассчитывается правильно
- [ ] При отмене задачи средства возвращаются

### Безопасность

- [ ] Нельзя создать платеж на отрицательную сумму
- [ ] Нельзя создать платеж на сумму > 100,000 ₽
- [ ] Вебхук проверяет userId в метаданных
- [ ] Платеж не зачисляется дважды (идемпотентность)
- [ ] API endpoints требуют авторизации

### Пользовательский опыт

- [ ] Модальное окно пополнения открывается
- [ ] Быстрый выбор суммы работает
- [ ] Страница результата оплаты работает
- [ ] Уведомления о пополнении приходят
- [ ] Ошибки понятно объясняются пользователю

## Частые проблемы

### Миграция не применяется

```bash
# Решение 1: Применить вручную
psql $DATABASE_URL < prisma/migrations/_convert_money_to_decimal/migration.sql

# Решение 2: Применить через Prisma
npx prisma migrate resolve --applied _convert_money_to_decimal
```

### Вебхук не работает

1. Проверить URL в настройках ЮKassa
2. Проверить, что сервер доступен извне
3. Проверить логи сервера
4. Проверить firewall и SSL сертификат

### Платеж не зачисляется

1. Проверить логи вебхука
2. Вручную проверить через `/api/wallet/check-payment?paymentId=xxx`
3. Проверить таблицу Transaction в БД

### Ошибка "credentials not configured"

Проверить `.env`:

```bash
echo $YOOKASSA_SHOP_ID
echo $YOOKASSA_SECRET_KEY
```

## Команды для отладки

```bash
# Проверить баланс пользователя
psql $DATABASE_URL -c "SELECT id, email, balance, \"frozenBalance\" FROM \"User\" WHERE email = 'test@example.com';"

# Проверить последние транзакции
psql $DATABASE_URL -c "SELECT * FROM \"Transaction\" ORDER BY \"createdAt\" DESC LIMIT 10;"

# Проверить платежи ЮKassa
psql $DATABASE_URL -c "SELECT * FROM \"Transaction\" WHERE type = 'yookassa_deposit' ORDER BY \"createdAt\" DESC;"

# Перегенерировать Prisma клиент
npx prisma generate

# Применить миграции
npx prisma migrate deploy

# Проверить статус миграций
npx prisma migrate status
```

## Контакты поддержки

- **ЮKassa**: support@yookassa.ru
- **Telegram поддержки ЮKassa**: @yookassa_support
- **Документация**: https://yookassa.ru/developers/

## Готово! ✅

После выполнения всех пунктов система полностью готова к работе.

**Не забудьте:**

- Сделать бэкап БД перед миграцией
- Протестировать на staging окружении
- Мониторить логи первые 24 часа после деплоя
