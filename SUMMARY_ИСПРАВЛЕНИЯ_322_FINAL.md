# üìù –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 322 –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —á–µ—Ä–µ–∑ –°–ë–ü

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ –°–ë–ü T-Bank API –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É:

```
ErrorCode: 322
Message: "–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
```

## üéØ –ù–∞–π–¥–µ–Ω–æ 2 –ø—Ä–∏—á–∏–Ω—ã

### –ü—Ä–∏—á–∏–Ω–∞ #1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø `FinalPayout`

–ü–∞—Ä–∞–º–µ—Ç—Ä `FinalPayout` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –∫–∞–∫ **boolean** (`true`), –∞ –Ω–µ –∫–∞–∫ **—Å—Ç—Ä–æ–∫–∞** (`"true"`).

### –ü—Ä–∏—á–∏–Ω–∞ #2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø `SbpMemberId`

–ü–∞—Ä–∞–º–µ—Ç—Ä `SbpMemberId` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –∫–∞–∫ **—Å—Ç—Ä–æ–∫–∞** (`"100000000004"`), –∞ –Ω–µ –∫–∞–∫ **—á–∏—Å–ª–æ** (`100000000004`).

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: FinalPayout (src/lib/tbank.ts, —Å—Ç—Ä–æ–∫–∞ 355)

**–ë—ã–ª–æ:**

```typescript
requestBody.FinalPayout = true // ‚ùå Boolean
```

**–°—Ç–∞–ª–æ:**

```typescript
requestBody.FinalPayout = 'true' // ‚úÖ –°—Ç—Ä–æ–∫–∞ (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ A2C_V2 —Å—Ç—Ä. 903)
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2: SbpMemberId (src/lib/tbank.ts, —Å—Ç—Ä–æ–∫–∞ 346)

**–ë—ã–ª–æ:**

```typescript
requestBody.SbpMemberId = params.sbpMemberId // ‚ùå –°—Ç—Ä–æ–∫–∞ "100000000004"
```

**–°—Ç–∞–ª–æ:**

```typescript
requestBody.SbpMemberId = Number(params.sbpMemberId) // ‚úÖ –ß–∏—Å–ª–æ 100000000004
```

### –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω —Ñ–∞–π–ª: test-signature.js

–û–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–∞–º.

---

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∑–∞–ø—Ä–æ—Å–µ –∫ API

**–ë—ã–ª–æ (—Å –æ—à–∏–±–∫–æ–π 322):**

```json
{
	"TerminalKey": "1763372956356E2C",
	"Amount": 10000,
	"OrderId": "withdraw_cmh4n1s4m0000v748r160zbdt_1763681982045",
	"DealId": "56868517",
	"PaymentRecipientId": "79662765973",
	"Phone": "79662765973",
	"SbpMemberId": "100000000004", // ‚ùå –°—Ç—Ä–æ–∫–∞
	"FinalPayout": true, // ‚ùå Boolean
	"NotificationURL": "https://nesi.su/api/wallet/tbank/webhook",
	"Token": "..."
}
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**

```json
{
	"TerminalKey": "1763372956356E2C",
	"Amount": 10000,
	"OrderId": "withdraw_cmh4n1s4m0000v748r160zbdt_1763681982045",
	"DealId": "56868517",
	"PaymentRecipientId": "79662765973",
	"Phone": "79662765973",
	"SbpMemberId": 100000000004, // ‚úÖ –ß–∏—Å–ª–æ
	"FinalPayout": "true", // ‚úÖ –°—Ç—Ä–æ–∫–∞
	"NotificationURL": "https://nesi.su/api/wallet/tbank/webhook",
	"Token": "..."
}
```

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å (Quickstart)

### –ù–∞ Windows (–ª–æ–∫–∞–ª—å–Ω–æ):

```powershell
cd C:\Users\Perfercher\Desktop\nesi\NESI
git add .
git commit -m "fix: –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∏–ø—ã FinalPayout –∏ SbpMemberId (–æ—à–∏–±–∫–∞ 322)"
git push origin main
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
cd ~/nesi-app
git pull origin main
npm run build
sudo systemctl restart nesi-app.service
sudo journalctl -u nesi-app.service -f
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. –í–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å
2. –ù–∞–∂–º–∏—Ç–µ "–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞"
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–º–∏–Ω–∏–º—É–º 100 ‚ÇΩ)
4. –í—ã–±–µ—Ä–∏—Ç–µ –°–ë–ü ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫
5. –ù–∞–∂–º–∏—Ç–µ "–í—ã–≤–µ—Å—Ç–∏"

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** ‚úÖ –£—Å–ø–µ—à–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞ –±–µ–∑ –æ—à–∏–±–∫–∏ 322

---

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

- ‚úÖ –í—ã–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –°–ë–ü —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ T-Bank –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Success: true`
- ‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
- ‚úÖ –ü–æ–ª—É—á–µ–Ω `PaymentId` –æ—Ç T-Bank
- ‚ùå –û—à–∏–±–∫–∞ 322 –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç

### –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

```
üì§ [TBANK] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É: {
  "SbpMemberId": 100000000004,  ‚Üê –ß–∏—Å–ª–æ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫
  "FinalPayout": "true",  ‚Üê –°—Ç—Ä–æ–∫–∞ —Å –∫–∞–≤—ã—á–∫–∞–º–∏
  ...
}

üì• [TBANK] –û—Ç–≤–µ—Ç –æ—Ç API: {
  success: true,  ‚Üê ‚úÖ
  errorCode: '0',
  paymentId: '7XXXXXXXXX'
}

‚úÖ [CREATE-WITHDRAWAL] –í—ã–ø–ª–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞
```

---

## üìö –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_FINALPAYOUT_STRING.md** - –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è FinalPayout
2. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_SBPMEMBERID_NUMBER.md** - –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è SbpMemberId
3. **–ö–ê–ö*–ü–†–ò–ú–ï–ù–ò–¢–¨*–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï.md** - –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

---

## üìä –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä             | –¢–∏–ø –≤ JSON    | –ü—Ä–∏–º–µ—Ä               | –ò—Å—Ç–æ—á–Ω–∏–∫                       |
| -------------------- | ------------- | -------------------- | ------------------------------ |
| `TerminalKey`        | String        | `"1763372956356E2C"` | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è                   |
| `Amount`             | Number        | `10000`              | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è                   |
| `OrderId`            | String        | `"withdraw_..."`     | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è                   |
| `DealId`             | String        | `"56868517"`         | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è                   |
| `PaymentRecipientId` | String        | `"79662765973"`      | A2C_V2 —Å—Ç—Ä. 15-16              |
| `Phone`              | String        | `"79662765973"`      | A2C_V2                         |
| `SbpMemberId`        | **Number** ‚ö†Ô∏è | `100000000004`       | multisplit.md —Å—Ç—Ä. 1083        |
| `FinalPayout`        | **String** ‚ö†Ô∏è | `"true"`             | vyplaty-multisplit.md —Å—Ç—Ä. 903 |
| `NotificationURL`    | String        | `"https://..."`      | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è                   |
| `Token`              | String        | `"abc..."`           | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è                   |

---

## üîÑ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `src/lib/tbank.ts` (—Å—Ç—Ä–æ–∫–∏ 346, 355)
2. ‚úÖ `test-signature.js` (—Å—Ç—Ä–æ–∫–∏ 16, 17)
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (3 –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–∞)

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ T-Bank

1. **SbpMemberId:**

   - –í —Ç–∞–±–ª–∏—Ü–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Å—Ç—Ä. 1083): **Number**
   - –í –ø—Ä–∏–º–µ—Ä–∞—Ö (—Å—Ç—Ä. 897-906): String `"100000000004"`
   - **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Number (–∫–∞–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ)

2. **FinalPayout:**
   - –í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤: boolean `true`
   - –í –ø—Ä–∏–º–µ—Ä–µ –°–ë–ü (—Å—Ç—Ä. 903): String `"true"`
   - **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å String (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –°–ë–ü)

### –ü–æ—á–µ–º—É –≤–∞–∂–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã?

T-Bank API —Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–∏–ø—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ JSON. –î–∞–∂–µ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"100000000004"` vs `100000000004`), –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É 322.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–¥–ø–∏—Å—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

```bash
cd ~/nesi-app
node test-signature.js
```

–ü–æ–¥–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å:

- `SbpMemberId` –∫–∞–∫ —á–∏—Å–ª–æ (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –≤ JSON)
- `FinalPayout` –∫–∞–∫ —Å—Ç—Ä–æ–∫—É (—Å –∫–∞–≤—ã—á–∫–∞–º–∏ –≤ JSON)

---

**–î–∞—Ç–∞:** 20 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–ª–∞—Ç—ã)

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –¥–≤—É—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤—ã–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –°–ë–ü –¥–æ–ª–∂–Ω—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å!
