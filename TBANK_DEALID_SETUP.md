# üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DealId –¥–ª—è –¢-–ë–∞–Ω–∫ –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

1. **–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—å Transaction:**

   - `dealId` - ID —Å–¥–µ–ª–∫–∏ –¢-–ë–∞–Ω–∫
   - `paymentId` - ID –ø–ª–∞—Ç–µ–∂–∞ –¢-–ë–∞–Ω–∫

2. **–û–±–Ω–æ–≤–ª–µ–Ω –≤–µ–±—Ö—É–∫:**

   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `dealId` –∏ `paymentId` –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ `paymentId`

3. **–û–±–Ω–æ–≤–ª–µ–Ω API –≤—ã–≤–æ–¥–∞:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π `dealId` –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã

## üìã –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:

```bash
cd NESI
npx prisma migrate dev --name add_tbank_deal_payment_ids
```

–ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é:

```sql
ALTER TABLE "Transaction" ADD COLUMN "dealId" TEXT;
ALTER TABLE "Transaction" ADD COLUMN "paymentId" TEXT;

CREATE INDEX "Transaction_dealId_idx" ON "Transaction"("dealId");
CREATE INDEX "Transaction_paymentId_idx" ON "Transaction"("paymentId");
```

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ `/api/wallet/tbank/create-payment`
2. –¢-–ë–∞–Ω–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `PaymentId` –∏ `DealId` (–∏–ª–∏ `SpAccumulationId`)
3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –≤–µ–±—Ö—É–∫ –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
4. –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
   - `dealId` - ID —Å–¥–µ–ª–∫–∏
   - `paymentId` - ID –ø–ª–∞—Ç–µ–∂–∞
   - `status: 'completed'`

### –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ `/api/wallet/tbank/create-withdrawal`
2. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π `dealId` –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
   ```typescript
   const lastDeposit = await prisma.transaction.findFirst({
   	where: {
   		userId: user.id,
   		type: 'deposit',
   		dealId: { not: null },
   		status: 'completed',
   	},
   	orderBy: { createdAt: 'desc' },
   })
   ```
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–π `dealId` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `dealId` –∏ `paymentId` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–≤–æ–¥–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **DealId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≤—ã–ø–ª–∞—Ç** - –±–µ–∑ –Ω–µ–≥–æ –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É
2. **–û–¥–∏–Ω DealId –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤—ã–ø–ª–∞—Ç** - –ø–æ–∫–∞ —Å–¥–µ–ª–∫–∞ –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞
3. **–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è** –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ `FinalPayout: true` –≤ –∑–∞–ø—Ä–æ—Å–µ –≤—ã–ø–ª–∞—Ç—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å (—Å–æ–∑–¥–∞—Å—Ç—Å—è DealId)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –ë–î:
   ```sql
   SELECT id, type, amount, "dealId", "paymentId", status
   FROM "Transaction"
   WHERE "userId" = 'your_user_id'
   ORDER BY "createdAt" DESC;
   ```
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ - –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π DealId

## üìù –õ–æ–≥–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è DealId:

```bash
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ 1000 ‚ÇΩ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é abc123 { paymentId: '...', dealId: '...' }
–ù–∞–π–¥–µ–Ω DealId –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è { userId: '...', dealId: '...' }
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é  
**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
