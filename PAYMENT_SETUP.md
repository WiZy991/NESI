# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ÆKassa

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–µ–Ω—å–≥–∞–º–∏:

### ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

1. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–ø–µ–µ–∫**

   - –í—Å–µ –¥–µ–Ω–µ–∂–Ω—ã–µ –ø–æ–ª—è –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã —Å `Int` –Ω–∞ `Decimal(10,2)`
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—É–º–º —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –∫–æ–ø–µ–µ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123.45 ‚ÇΩ)

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏**

   - –ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å (–¥–µ–Ω—å–≥–∏ –≤ —Ä–∞–±–æ—Ç–µ)
   - –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π —Å—É–º–º—ã

3. **–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–µ–Ω—å–≥–∞–º–∏** (`src/lib/money.ts`)

   - `parseUserInput()` - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `formatMoney()` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –≤–∞–ª—é—Ç–æ–π
   - `hasEnoughBalance()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤
   - `calculatePercentage()` - –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (–∫–æ–º–∏—Å—Å–∏—è)

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa**
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ API
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ÆKassa

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ https://yookassa.ru/
2. –°–æ–∑–¥–∞–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω
3. –ü–æ–ª—É—á–∏—Ç–µ Shop ID –∏ Secret Key –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–¢–æ–∫–µ–Ω—ã –¥–ª—è API"

### 2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```env
# –ÆKassa
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key

# URL –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ (–¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)
NEXT_PUBLIC_BASE_URL=https://yourdomain.com
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ –≤ –ÆKassa

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
3. –î–æ–±–∞–≤—å—Ç–µ URL –≤–µ–±—Ö—É–∫–∞: `https://yourdomain.com/api/wallet/yookassa-webhook`
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ: `payment.succeeded`

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö:

```bash
cd NESI
npx prisma migrate deploy
```

–ò–ª–∏ –¥–ª—è dev –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
npx prisma migrate dev
```

## API Endpoints

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

**POST** `/api/wallet/create-payment`

```json
{
	"amount": 1000.5
}
```

–û—Ç–≤–µ—Ç:

```json
{
	"success": true,
	"paymentId": "payment_id",
	"confirmationUrl": "https://yoomoney.ru/checkout/...",
	"amount": 1000.5
}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

**GET** `/api/wallet/check-payment?paymentId=payment_id`

–û—Ç–≤–µ—Ç:

```json
{
	"status": "succeeded",
	"paid": true,
	"amount": 1000.5,
	"processed": true
}
```

### 3. –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**GET** `/api/wallet/balance`

–û—Ç–≤–µ—Ç:

```json
{
	"balance": 1500.75,
	"frozenBalance": 500.0,
	"availableBalance": 1000.75
}
```

### 4. –í–µ–±—Ö—É–∫ (–¥–ª—è –ÆKassa)

**POST** `/api/wallet/yookassa-webhook`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –ÆKassa

## –ü—Ä–∏–º–µ—Ä —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
async function depositBalance(amount: number) {
	const response = await fetch('/api/wallet/create-payment', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ amount }),
	})

	const data = await response.json()

	if (data.confirmationUrl) {
		// –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ÆKassa
		window.location.href = data.confirmationUrl
	}
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (–ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å –ÆKassa)
async function checkPayment(paymentId: string) {
	const response = await fetch(
		`/api/wallet/check-payment?paymentId=${paymentId}`
	)
	const data = await response.json()

	if (data.paid && data.processed) {
		alert('–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!')
		// –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
	}
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏**

   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å

2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π**

   - –ö–∞–∂–¥—ã–π –ø–ª–∞—Ç–µ–∂ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—á–∏—Å–ª–µ–Ω–∏–π

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º**

   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 1.00 ‚ÇΩ
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 100,000.00 ‚ÇΩ
   - –ü–∞—Ä—Å–∏–Ω–≥ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞**
   - –ü–ª–∞—Ç–µ–∂–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ userId
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ÆKassa

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:

- **–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂**: `5555 5555 5555 4477`
- **–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂**: `5555 5555 5555 4444`
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞
- CVC: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –°–æ–∑–¥–∞–π—Ç–µ –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ API
2. –û—Ç–∫—Ä–æ–π—Ç–µ `confirmationUrl` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π
4. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:

```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞
‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è user_id –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ 1000.50 ‚ÇΩ
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ë–î:

```sql
SELECT * FROM "Transaction"
WHERE type = 'yookassa_deposit'
ORDER BY "createdAt" DESC
LIMIT 10;
```

## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞—á–∏—Å–ª–∏–ª—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–µ–±—Ö—É–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `/api/wallet/check-payment`

### –û—à–∏–±–∫–∞ "credentials not configured"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env`:

```env
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxx
```

### –î–≤–æ–π–Ω–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ

–ó–∞—â–∏—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É:

```typescript
const existingTransaction = await prisma.transaction.findFirst({
	where: {
		type: 'yookassa_deposit',
		reason: { contains: payment.id },
	},
})
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ÆKassa –∞–∫–∫–∞—É–Ω—Ç
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±—Ö—É–∫–∏
5. üî≤ –°–æ–∑–¥–∞—Ç—å UI –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
6. üî≤ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
7. üî≤ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ÆKassa: https://yookassa.ru/developers/
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ÆKassa: support@yookassa.ru
