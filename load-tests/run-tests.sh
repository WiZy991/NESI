#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run-tests.sh [environment] [output-dir]

set -e

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
ENVIRONMENT=${1:-"local"}
OUTPUT_DIR=${2:-"results"}
BASE_URL="https://nesi-production.up.railway.app/"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è
case $ENVIRONMENT in
  "local")
    BASE_URL="http://localhost:3000"
    ;;
  "staging")
    BASE_URL="https://staging.nesi.com"
    ;;
  "production")
    BASE_URL="https://nesi-production.up.railway.app/"
    ;;
  *)
    echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: $ENVIRONMENT"
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ: local, staging, production"
    exit 1
    ;;
esac

echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è: $ENVIRONMENT"
echo "üì° –ë–∞–∑–æ–≤—ã–π URL: $BASE_URL"
echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $OUTPUT_DIR"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
mkdir -p $OUTPUT_DIR

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞
run_test() {
  local test_name=$1
  local test_file=$2
  local description=$3
  
  echo ""
  echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞: $test_name"
  echo "üìù –û–ø–∏—Å–∞–Ω–∏–µ: $description"
  echo "‚è±Ô∏è  –ù–∞—á–∞–ª–æ: $(date)"
  
  # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  k6 run \
    --env BASE_URL=$BASE_URL \
    --out json=$OUTPUT_DIR/${test_name}-results.json \
    --out csv=$OUTPUT_DIR/${test_name}-results.csv \
    $test_file > $OUTPUT_DIR/${test_name}-output.log 2>&1
  
  local exit_code=$?
  
  if [ $exit_code -eq 0 ]; then
    echo "‚úÖ –¢–µ—Å—Ç $test_name –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
  else
    echo "‚ùå –¢–µ—Å—Ç $test_name –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–∞–º–∏ (–∫–æ–¥: $exit_code)"
  fi
  
  echo "‚è±Ô∏è  –ö–æ–Ω–µ—Ü: $(date)"
  echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ $OUTPUT_DIR/${test_name}-*"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
generate_summary() {
  echo ""
  echo "üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."
  
  cat > $OUTPUT_DIR/summary.md << EOF
# –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

**–û–∫—Ä—É–∂–µ–Ω–∏–µ**: $ENVIRONMENT  
**–ë–∞–∑–æ–≤—ã–π URL**: $BASE_URL  
**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è**: $(date)  
**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**: $OUTPUT_DIR

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

EOF

  # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ
  for test_file in *.js; do
    if [ "$test_file" != "config.js" ]; then
      test_name=$(basename $test_file .js)
      if [ -f "$OUTPUT_DIR/${test_name}-results.json" ]; then
        echo "- ‚úÖ $test_name" >> $OUTPUT_DIR/summary.md
      else
        echo "- ‚ùå $test_name (–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω)" >> $OUTPUT_DIR/summary.md
      fi
    fi
  done

  cat >> $OUTPUT_DIR/summary.md << EOF

## –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª—ã \`*-results.json\` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–∞—Ö \`*-output.log\`
- CSV –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ Excel/Google Sheets: \`*-results.csv\`

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–µ—Å—Ç—ã —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –æ—à–∏–±–æ–∫
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (p95) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ endpoint
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
2. –í—ã—è–≤–∏—Ç–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –í–Ω–µ–¥—Ä–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---
*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ $(date)*
EOF

  echo "üìã –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ $OUTPUT_DIR/summary.md"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è k6
if ! command -v k6 &> /dev/null; then
    echo "‚ùå K6 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ K6 –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤."
    echo "üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ: https://k6.io/docs/getting-started/installation/"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -s --head $BASE_URL > /dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: $BASE_URL"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
echo ""
echo "üéØ –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤..."

# 1. –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
run_test "auth-load" "auth-load-test.js" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"

# 2. –¢–µ—Å—Ç API
run_test "api-load" "api-load-test.js" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö API endpoints"

# 3. –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç
run_test "stress" "stress-test.js" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–¥ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π"

# 4. –°–ø–∞–π–∫-—Ç–µ—Å—Ç
run_test "spike" "spike-test.js" "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Ä–µ–∑–∫–∏–µ —Å–∫–∞—á–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏"

# 5. –û–±—ä–µ–º–Ω—ã–π —Ç–µ—Å—Ç
run_test "volume" "volume-test.js" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤"

# 6. –¢–µ—Å—Ç –Ω–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å (—Ç–æ–ª—å–∫–æ –¥–ª—è staging/production)
if [ "$ENVIRONMENT" != "local" ]; then
    run_test "endurance" "endurance-test.js" "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ"
fi

# 7. –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç
run_test "full-load" "full-load-test.js" "–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
generate_summary

echo ""
echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $OUTPUT_DIR"
echo "üìã –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç: $OUTPUT_DIR/summary.md"
echo ""
echo "üìä –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
echo "   - JSON —Ñ–∞–π–ª—ã: –¥–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏"
echo "   - CSV —Ñ–∞–π–ª—ã: –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤"
echo "   - –õ–æ–≥–∏: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö"
echo "   - Summary: –æ–±—â–∞—è —Å–≤–æ–¥–∫–∞"
echo ""
echo "üîç –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:"
echo "   1. –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ"
echo "   2. –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (p95) –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π"
echo "   3. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å rate limiting"
echo "   4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è"

