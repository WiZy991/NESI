# üöÄ –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –¢-–ë–∞–Ω–∫ –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#1-–ø—Ä–æ–≤–µ—Ä–∫–∞-—Ç–µ–∫—É—â–µ–≥–æ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
2. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è](#2-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
3. [–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î](#3-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ-–º–∏–≥—Ä–∞—Ü–∏–∏-–±–¥)
4. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞](#4-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–≤–µ–±—Ö—É–∫–∞-–≤-–ª–∏—á–Ω–æ–º-–∫–∞–±–∏–Ω–µ—Ç–µ-—Ç-–±–∞–Ω–∫–∞)
5. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#5-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
6. [–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](#6-—Ä–µ—à–µ–Ω–∏–µ-–ø—Ä–æ–±–ª–µ–º)

---

## 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –û—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

**‚ùå –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏:**

```
POST https://nesi.su/api/wallet/tbank/create-payment 500 (Internal Server Error)
```

**‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ:**

```
–ù–µ –Ω–∞–π–¥–µ–Ω DealId –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. ‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`TBANK_TERMINAL_KEY`, `TBANK_PASSWORD`)
2. ‚ùå –ù–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è `dealId`, `paymentId`)
3. ‚ùå –í–µ–±—Ö—É–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞
4. ‚ùå –í–µ–±—Ö—É–∫ –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ (—Ñ–∞–π—Ä–≤–æ–ª, IP whitelist)

---

## 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 2.1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –¢-–ë–∞–Ω–∫–∞

–í–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç –¢-–ë–∞–Ω–∫–∞:

1. **TerminalKey** - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
2. **Password** - –ø–∞—Ä–æ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏
3. **E2C TerminalKey** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - —Ç–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è –≤—ã–ø–ª–∞—Ç

**–ì–¥–µ –Ω–∞–π—Ç–∏:**

- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¢-–ë–∞–Ω–∫–∞ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
- –ò–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ —É –≤–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞

### 2.2. –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.local` (–∏–ª–∏ `.env`) –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ `NESI`:

```bash
# Database
DATABASE_URL="postgresql://user:password@host:5432/nesi"

# NextAuth
NEXTAUTH_URL="https://nesi.su"
NEXTAUTH_SECRET="–≤–∞—à_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á"

# –¢-–ë–∞–Ω–∫ –ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã
TBANK_TERMINAL_KEY="–≤–∞—à_terminal_key_–æ—Ç_—Ç–±–∞–Ω–∫–∞"
TBANK_PASSWORD="–≤–∞—à_password_–æ—Ç_—Ç–±–∞–Ω–∫–∞"

# E2C —Ç–µ—Ä–º–∏–Ω–∞–ª (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)
TBANK_E2C_TERMINAL_KEY="–≤–∞—à_e2c_terminal_key"

# App URL –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤
NEXT_PUBLIC_APP_URL="https://nesi.su"

# –†–µ–∂–∏–º (production –¥–ª—è –±–æ–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)
NODE_ENV="production"
```

### 2.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ PM2:**

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
pm2 env 0

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è .env
pm2 restart all --update-env
```

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker:**

```bash
# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose down
docker-compose up -d --build
```

---

## 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

### 3.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—è `dealId` –∏ `paymentId` –≤ —Ç–∞–±–ª–∏—Ü–µ `Transaction`:

```bash
cd NESI
npx prisma studio
```

–û—Ç–∫—Ä–æ–π—Ç–µ –º–æ–¥–µ–ª—å `Transaction` –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª–µ–π.

### 3.2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Prisma (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```bash
cd NESI
npx prisma migrate deploy
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL**

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è dealId –∏ paymentId
ALTER TABLE "Transaction" ADD COLUMN IF NOT EXISTS "dealId" TEXT;
ALTER TABLE "Transaction" ADD COLUMN IF NOT EXISTS "paymentId" TEXT;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS "Transaction_dealId_idx" ON "Transaction"("dealId");
CREATE INDEX IF NOT EXISTS "Transaction_paymentId_idx" ON "Transaction"("paymentId");
```

**–í–∞—Ä–∏–∞–Ω—Ç C: –§–∞–π–ª —É–∂–µ –≥–æ—Ç–æ–≤**

–í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª `apply_dealid_migration.sql`. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ:

```bash
psql -U your_user -d nesi -f apply_dealid_migration.sql
```

### 3.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'Transaction'
  AND column_name IN ('dealId', 'paymentId')
ORDER BY column_name;
```

–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:

- `dealId` (TEXT, YES)
- `paymentId` (TEXT, YES)

---

## 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞

### 4.1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¢-–ë–∞–Ω–∫–∞

1. –í–æ–π–¥–∏—Ç–µ –Ω–∞ https://business.tbank.ru/
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **"–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥"**
3. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ç–µ—Ä–º–∏–Ω–∞–ª
4. –û—Ç–∫—Ä–æ–π—Ç–µ **"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞"**

### 4.2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ URL –≤–µ–±—Ö—É–∫–∞

–í —Ä–∞–∑–¥–µ–ª–µ **"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"** –∏–ª–∏ **"Webhooks"** —É–∫–∞–∂–∏—Ç–µ:

```
URL: https://nesi.su/api/wallet/tbank/webhook
–ú–µ—Ç–æ–¥: POST
–§–æ—Ä–º–∞—Ç: JSON
```

### 4.3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–µ–±—Ö—É–∫ –∞–∫—Ç–∏–≤–µ–Ω

- ‚úÖ –í–µ–±—Ö—É–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–≤–∫–ª—é—á–µ–Ω**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤:
  - `AUTHORIZED` (—Ö–æ–ª–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
  - `CONFIRMED` (—Å–ø–∏—Å–∞–Ω–∏–µ)
  - `REJECTED` (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)

### 4.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±—Ö—É–∫–∞

–¢-–ë–∞–Ω–∫ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
curl -X GET https://nesi.su/api/wallet/tbank/webhook
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:

```json
{
	"status": "ok",
	"message": "Webhook is available. Use POST method to send notifications.",
	"endpoint": "/api/wallet/tbank/webhook",
	"method": "POST"
}
```

### 4.5. IP Whitelist (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

–ï—Å–ª–∏ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ IP, –¥–æ–±–∞–≤—å—Ç–µ IP –∞–¥—Ä–µ—Å–∞ –¢-–ë–∞–Ω–∫–∞ –≤ whitelist:

```
185.71.76.0/27
185.71.77.0/27
```

---

## 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 5.1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://nesi.su/wallet
2. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"**
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–º–∏–Ω–∏–º—É–º 1 ‚ÇΩ)
4. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–ø–æ–ª–Ω–∏—Ç—å"**

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã –¢-–ë–∞–Ω–∫–∞
- ‚úÖ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å–∞–π—Ç
- ‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è

### 5.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

**–õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**

```
üì• [WEBHOOK] –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç T-Bank
üìä [WEBHOOK] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞—Ç–µ–∂–∞: { Status: 'CONFIRMED', SpAccumulationId: 123456, ... }
üí∞ [WEBHOOK] –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ: { dealId: '123456', ... }
‚úÖ [WEBHOOK] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:**

```bash
# PM2
pm2 logs

# Docker
docker logs your-container-name

# –ù–∞–ø—Ä—è–º—É—é
tail -f /path/to/logs/app.log
```

### 5.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

```sql
SELECT id, type, amount, dealId, paymentId, createdAt
FROM "Transaction"
WHERE type = 'deposit'
ORDER BY createdAt DESC
LIMIT 5;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ `dealId` –Ω–µ NULL
- ‚úÖ `paymentId` –Ω–µ NULL

### 5.4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://nesi.su/wallet
2. –ù–∞–∂–º–∏—Ç–µ **"–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞"**
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–º–∏–Ω–∏–º—É–º 100 ‚ÇΩ)
4. –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (–∫–∞—Ä—Ç–∞ –∏–ª–∏ –°–ë–ü)
5. –ù–∞–∂–º–∏—Ç–µ **"–í—ã–≤–µ—Å—Ç–∏"**

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ –í—ã–ø–ª–∞—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–∫–∏ "–ù–µ –Ω–∞–π–¥–µ–Ω DealId"

---

## 6. –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ `.env` –∏–ª–∏ `.env.local`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
   ```
   TBANK_TERMINAL_KEY=–≤–∞—à_–∫–ª—é—á
   TBANK_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å
   ```
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo $TBANK_TERMINAL_KEY
echo $TBANK_PASSWORD

# –ò–ª–∏ –≤ –∫–æ–¥–µ Node.js
node -e "console.log(process.env.TBANK_TERMINAL_KEY)"
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: DealId –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –í–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ –≤ –¢-–ë–∞–Ω–∫–µ:**

   - URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `https://nesi.su/api/wallet/tbank/webhook`
   - –í–µ–±—Ö—É–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±—Ö—É–∫–∞:**

   ```bash
   curl -X GET https://nesi.su/api/wallet/tbank/webhook
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:**

   - –ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ `[WEBHOOK]`
   - –ï—Å–ª–∏ –ª–æ–≥–æ–≤ –Ω–µ—Ç - –≤–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP whitelist:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ IP –¢-–ë–∞–Ω–∫–∞ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –í–µ–±—Ö—É–∫ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ DealId = null

**–ü—Ä–∏—á–∏–Ω–∞:** –¢-–ë–∞–Ω–∫ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç SpAccumulationId –≤ –≤–µ–±—Ö—É–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏:**

   - –í –∑–∞–ø—Ä–æ—Å–µ `/v2/Init` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `CreateDealWithType: "NN"`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `[TBANK] –°–æ–∑–¥–∞–µ–º —Å–¥–µ–ª–∫—É`

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∏–ø —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:**

   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å **–ø–æ–¥–∫–ª—é—á–µ–Ω** –ø—Ä–æ–¥—É–∫—Ç "–ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã"
   - –ó–∞–ø—Ä–æ—Å–∏—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¢-–ë–∞–Ω–∫–∞

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DealId:**
   ```bash
   curl -X POST https://nesi.su/api/wallet/tbank/update-deal-ids \
     -H "Authorization: Bearer –≤–∞—à_—Ç–æ–∫–µ–Ω"
   ```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –û—à–∏–±–∫–∞ "DealId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å DealId

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ –¢-–ë–∞–Ω–∫
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–Ω–æ–≤–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—è `dealId` –∏ `paymentId` –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ

**–†–µ—à–µ–Ω–∏–µ:**

```sql
-- –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π
ALTER TABLE "Transaction" ADD COLUMN IF NOT EXISTS "dealId" TEXT;
ALTER TABLE "Transaction" ADD COLUMN IF NOT EXISTS "paymentId" TEXT;

-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
CREATE INDEX IF NOT EXISTS "Transaction_dealId_idx" ON "Transaction"("dealId");
CREATE INDEX IF NOT EXISTS "Transaction_paymentId_idx" ON "Transaction"("paymentId");
```

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–¢-–ë–∞–Ω–∫:**

- Email: acq_help@tbank.ru
- –¢–µ–ª–µ—Ñ–æ–Ω: —É–∫–∞–∑–∞–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**

- [–¢-–ë–∞–Ω–∫ API](https://www.tbank.ru/kassa/dev/)
- [–ú—É–ª—å—Ç–∏—Ä–∞—Å—á–µ—Ç—ã](./multisplit.md)
- [EACQ –ø—Ä–æ—Ç–æ–∫–æ–ª](./oplata_multisplit.md)
- [A2C –ø—Ä–æ—Ç–æ–∫–æ–ª](./vyplaty-multisplit.md)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —É–±–µ–¥–∏—Ç–µ—Å—å:

- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [ ] –í–µ–±—Ö—É–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –¢-–ë–∞–Ω–∫–µ
- [ ] –í–µ–±—Ö—É–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (GET –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200)
- [ ] –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [ ] DealId —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [ ] –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

---

## üéØ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (TL;DR)

```bash
# 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env
echo 'TBANK_TERMINAL_KEY="–≤–∞—à_–∫–ª—é—á"' >> .env
echo 'TBANK_PASSWORD="–≤–∞—à_–ø–∞—Ä–æ–ª—å"' >> .env

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
cd NESI
npx prisma migrate deploy

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pm2 restart all --update-env

# 4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–µ–±—Ö—É–∫ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞
# URL: https://nesi.su/api/wallet/tbank/webhook

# 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±—Ö—É–∫–∞
curl https://nesi.su/api/wallet/tbank/webhook

# 6. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- [TBANK_SETUP.md](./TBANK_SETUP.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
- [TBANK_DEALID_SETUP.md](./TBANK_DEALID_SETUP.md) - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DealId
- [TBANK_TROUBLESHOOTING.md](./TBANK_TROUBLESHOOTING.md) - –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- [APPLY_DEALID_MIGRATION.md](./APPLY_DEALID_MIGRATION.md) - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ù–æ—è–±—Ä—å 2024
