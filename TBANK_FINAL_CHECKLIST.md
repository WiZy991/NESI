# ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¢-–ë–∞–Ω–∫

## üîê 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env –∏–ª–∏ .env.local)

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

```env
# ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
TBANK_TERMINAL_KEY=1763372956356
TBANK_PASSWORD=iGsy0RJ8%QqtBI3b

# ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¥–ª—è –≤—ã–ø–ª–∞—Ç
TBANK_E2C_TERMINAL_KEY=1763372956356E2C

# ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ –∏ –≤–µ–±—Ö—É–∫–æ–≤
NEXT_PUBLIC_APP_URL=https://nesi.su

# ‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ (production –¥–ª—è –±–æ–µ–≤–æ–≥–æ)
NODE_ENV=production
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
echo $TBANK_TERMINAL_KEY
echo $TBANK_E2C_TERMINAL_KEY
echo $TBANK_PASSWORD
echo $NEXT_PUBLIC_APP_URL
```

---

## üóÑÔ∏è 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã)
npx prisma migrate deploy

# –ò–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npx prisma migrate dev
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ö–µ–º—É –ë–î:

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `Transaction` –µ—Å—Ç—å –ø–æ–ª—è:
- `dealId` (String, nullable)
- `paymentId` (String, nullable)

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã Transaction
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'Transaction' 
AND column_name IN ('dealId', 'paymentId');
```

---

## üåê 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ –≤ –¢-–ë–∞–Ω–∫–µ

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!** –í–µ–±—Ö—É–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞:

1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¢-–ë–∞–Ω–∫–∞
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
3. –£–∫–∞–∂–∏—Ç–µ URL –≤–µ–±—Ö—É–∫–∞:
   ```
   https://nesi.su/api/wallet/tbank/webhook
   ```
4. –ú–µ—Ç–æ–¥: **POST**
5. –§–æ—Ä–º–∞—Ç: **JSON**

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (–Ω–µ localhost)
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å HTTPS (–¥–ª—è –±–æ–µ–≤–æ–≥–æ)
- –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å POST –∑–∞–ø—Ä–æ—Å—ã

---

## üìÅ 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ:

### Backend:
- ‚úÖ `src/lib/tbank.ts` - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
- ‚úÖ `src/app/api/wallet/tbank/create-payment/route.ts` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ `src/app/api/wallet/tbank/create-withdrawal/route.ts` - —Å–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã
- ‚úÖ `src/app/api/wallet/tbank/webhook/route.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤
- ‚úÖ `src/app/api/wallet/tbank/check-payment/route.ts` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ `src/app/api/wallet/tbank/update-deal-ids/route.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ DealId

### Frontend:
- ‚úÖ `src/app/wallet/payment-success/page.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞
- ‚úÖ `src/app/wallet/payment-failed/page.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏
- ‚úÖ UI –∫–Ω–æ–ø–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è/–≤—ã–≤–æ–¥–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ

---

## üîç 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:

```typescript
// src/lib/tbank.ts
// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
process.env.TBANK_TERMINAL_KEY      // –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
process.env.TBANK_E2C_TERMINAL_KEY  // –¥–ª—è –≤—ã–ø–ª–∞—Ç
process.env.TBANK_PASSWORD          // –¥–ª—è —Ç–æ–∫–µ–Ω–∞
process.env.NEXT_PUBLIC_APP_URL     // –¥–ª—è URL
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL API:

```typescript
// src/lib/tbank.ts - —Ñ—É–Ω–∫—Ü–∏—è getApiUrl()
// –î–ª—è production –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: https://securepay.tinkoff.ru
// –î–ª—è test: https://rest-api-test.tinkoff.ru
```

---

## üß™ 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å ‚Üí –ö–æ—à–µ–ª—ë–∫
2. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ –¢-–ë–∞–Ω–∫"
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100 ‚ÇΩ)
4. –î–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã –¢-–ë–∞–Ω–∫–∞
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è
7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å DealId)

### –¢–µ—Å—Ç –≤—ã–≤–æ–¥–∞:

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å –±–∞–ª–∞–Ω—Å –∏ DealId –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
2. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤—ã–≤–æ–¥–∞
3. –ù–∞–∂–º–∏—Ç–µ "–í—ã–≤–µ—Å—Ç–∏"
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–∏–ª—Å—è

---

## üìä 7. –õ–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏:

```bash
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
üí≥ [CREATE-PAYMENT] –û—Ç–≤–µ—Ç –æ—Ç –¢-–ë–∞–Ω–∫–∞: { paymentId: ..., dealId: ... }
üì• [WEBHOOK] –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç T-Bank
‚úÖ [WEBHOOK] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ: { amount: ..., dealId: ... }
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ:

```bash
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
üìã [CREATE-WITHDRAWAL] –ù–∞–π–¥–µ–Ω DealId –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ...
üì§ [TBANK] –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã: { orderId: ..., amount: ... }
‚úÖ [CREATE-WITHDRAWAL] –í—ã–ø–ª–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: { PaymentId: ... }
```

---

## ‚ö†Ô∏è 8. –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "DealId –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –±—ã–ª–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–µ–±—Ö—É–∫ –æ–±—Ä–∞–±–æ—Ç–∞–ª—Å—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å DealId –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–û–±–Ω–æ–≤–∏—Ç—å DealId" (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ UI)
4. –ò–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç - –≤–µ–±—Ö—É–∫ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

### –ü—Ä–æ–±–ª–µ–º–∞: "TBANK_E2C_TERMINAL_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É–∫–∞–∑–∞–Ω–∞: `TBANK_E2C_TERMINAL_KEY=1763372956356E2C`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env`

### –ü—Ä–æ–±–ª–µ–º–∞: "–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å –≤–µ–±—Ö—É–∫–∞"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TBANK_PASSWORD` - –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ø–∞—Ä–æ–ª–µ–º –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä–æ–ª—å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –±–æ–µ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –í–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (–Ω–µ localhost)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
  - [ ] `TBANK_TERMINAL_KEY` = `1763372956356`
  - [ ] `TBANK_E2C_TERMINAL_KEY` = `1763372956356E2C`
  - [ ] `TBANK_PASSWORD` = `iGsy0RJ8%QqtBI3b`
  - [ ] `NEXT_PUBLIC_APP_URL` = `https://nesi.su`
  - [ ] `NODE_ENV` = `production`

- [ ] **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
  - [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
  - [ ] –ü–æ–ª—è `dealId` –∏ `paymentId` —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `Transaction`

- [ ] **–í–µ–±—Ö—É–∫:**
  - [ ] URL —É–∫–∞–∑–∞–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢-–ë–∞–Ω–∫–∞: `https://nesi.su/api/wallet/tbank/webhook`
  - [ ] –ú–µ—Ç–æ–¥: POST
  - [ ] –§–æ—Ä–º–∞—Ç: JSON

- [ ] **–§–∞–π–ª—ã:**
  - [ ] –í—Å–µ API —Ä–æ—É—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ
  - [ ] –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `tbank.ts` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  - [ ] –°—Ç—Ä–∞–Ω–∏—Ü—ã success/failed —Å—É—â–µ—Å—Ç–≤—É—é—Ç

- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
  - [ ] –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
  - [ ] –í—ã–≤–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
  - [ ] DealId —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
  - [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–ï—Å–ª–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã –æ—Ç–º–µ—á–µ–Ω—ã, —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. 

**–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12 ‚Üí Console)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ë–î
4. –°–º. `TBANK_DEALID_SOLUTION.md` –¥–ª—è –ø—Ä–æ–±–ª–µ–º —Å DealId
5. –°–º. `TBANK_TROUBLESHOOTING.md` –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º

